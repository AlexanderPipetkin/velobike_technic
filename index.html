<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velobike Technic</title>
    <link rel="icon" href="style/static/images/logo64.png" type="image/x-icon">
    <link rel="manifest" href="script/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="–¢—É—Ç –±—ã–ª –ª–µ—Ö–∞">
    <link rel="apple-touch-icon" href="style/static/images/logo64.png">
    <link rel="stylesheet" href="style/v_t-main.css">
</head>
<body>
    <section id="main" class="page">
        <div class="container">

            <div class="welcome-card">
                <div class="welcome-content">
                    <h2 class="welcome-title" id="welcome-title">
                        –ü—Ä–∏–≤–µ—Ç, <span id="user-name">–ø–∞—Ä–µ–Ω—å</span>!
                    </h2>
                    <p class="welcome-date" id="current-date"></p>
                </div>
            </div>

            <div class="shift-notification" id="shift-notification" style="display: none;">
                <div class="shift-notification-content">
                    <div class="shift-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" fill="none">
                        <circle cx="50" cy="50" r="50" fill="white"/>
                        <path d="M48.168 37.688V30.2H54.44V37.688H48.168ZM48.104 75V48.568H42.408L44.264 43.384H54.44V75H48.104Z" fill="black"/>
                        </svg>
                    </div>
                    <div class="shift-text">
                        <h3 class="shift-title">–°–ª–æ—Ç –≤–æ—Ç-–≤–æ—Ç –Ω–∞—á–Ω–µ—Ç—Å—è!</h3>
                        <p class="shift-description">–¢—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å–≤–æ–π —Å–ª–æ—Ç</p>
                    </div>
                </div>
                <button class="shift-start-btn" id="start-shift-btn">–ù–∞—á–∞—Ç—å —Å–ª–æ—Ç</button>
            </div>

            <!-- –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            <div class="important-news">
                <div class="news-header">
                    <h3 class="news-title">–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <button class="refresh-news-btn" id="refresh-news-btn" title="–û–±–Ω–æ–≤–∏—Ç—å">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                </button>
                </div>
                <div class="news-list" id="news-list">
                    <div class="news-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
                </div>
            </div> -->

            <div class="pwa-promo" id="pwa-promo" style="display: none;">
                <div class="pwa-card">
                    <h3>–ë—Ä–∞—Ç–∞–Ω, —Å–∫–∞—á–∞–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                    <p>–¢–æ—Ç –∂–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –Ω–æ —Ç–∏–ø–∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—É—Å–∫, —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω, –Ω—É –∏ –∏–∫–æ–Ω–∫–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ</p>
                    <button class="pwa-install-btn" id="pwa-install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
                    <div class="pwa-instructions">
                        <p><strong>Android:</strong> –ú–µ–Ω—é ‚Üí "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</p>
                        <p><strong>iPhone:</strong> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section id="slots" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–ú–µ–Ω—é —Å–ª–æ—Ç–æ–≤</h1>
            </div>

            <div class="calendar-section" style="margin-bottom: 0px;">
                <h2 class="section-title">–î–∞—Ç–∞ —Å–º–µ–Ω—ã</h2>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendar-month">–î–µ–∫–∞–±—Ä—å 2025</div>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="weekday">–ü–Ω</div>
                        <div class="weekday">–í—Ç</div>
                        <div class="weekday">–°—Ä</div>
                        <div class="weekday">–ß—Ç</div>
                        <div class="weekday">–ü—Ç</div>
                        <div class="weekday">–°–±</div>
                        <div class="weekday">–í—Å</div>
                    </div>
                    <div class="calendar-days" id="calendar-days">
                        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JS -->
                    </div>
                </div>
            </div>

            <div class="past-slots-btn-container" style="margin-bottom: 20px;">
                <button class="past-slots-btn" id="past-slots-btn" style="width: 100%; padding: 12px 16px; border-radius: var(--border-radius); border: transparent; background: transparent; color: var(--primary-text); font-size: 14px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
                    –ú–æ–∏ –ø—Ä–æ—à–ª—ã–µ —Å–ª–æ—Ç—ã
                </button>
            </div>

            <div class="zones-section" style="display: none; margin-bottom: 30px;">
                <h2 class="section-title">–í—ã–±–æ—Ä –∑–æ–Ω—ã</h2>
                <div class="zones-container">
                    <div class="zones-map-container">
                        <div id="zones-svg-container"></div>
                    </div>
                </div>
            </div>

            <div class="zone-confirmation-section" style="display: none; margin-bottom: 30px;">
                <div class="zone-info-card">
                    <div class="zone-info-body">
                        <div class="zone-confirmation-text" id="zone-confirmation-text">
                            –¢—ã –≤—ã–±—Ä–∞–ª –∑–æ–Ω—É <span id="zone-name-span">3–´</span><br>
                            –ó–Ω–∞—á–∏—Ç –±—É–¥–µ—à—å –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å —Ä–∞–π–æ–Ω—ã:
                        </div>
                        <div class="zone-districts-list" id="zone-districts-list">
                            <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JS -->
                        </div>
                    </div>
                    <div class="zone-info-footer">
                        <button class="zone-confirm-btn primary" id="send-slot-btn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Å–ª–æ—Ç
                        </button>
                        <button class="zone-confirm-btn secondary" id="cancel-zone-btn">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="stool" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–¢–∞–±—É—Ä–µ—Ç</h1>
                <p class="page-description">–ö—É—Ä–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ</p>
            </div>
            
            <div class="stool-buttons-container">
                <div class="stool-btn-wrapper" id="stool-damage-btn">
                    <div class="stool-btn-icon">
                        <img src="style/static/images/icons/damage.png" alt="–ü–æ–ª–æ–º–∫–∏" class="stool-icon-img">
                    </div>
                    <div class="stool-btn-content">
                        <h3 class="stool-btn-title">–ü–æ–ª–æ–º–∫–∏</h3>
                        <p class="stool-btn-description">–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ –±–µ–∑ "–†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è"</p>
                    </div>
                    <div class="stool-btn-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
                
                <div class="stool-btn-wrapper" id="stool-fine-btn">
                    <div class="stool-btn-icon">
                        <img src="style/static/images/icons/fine.png" alt="–®—Ç—Ä–∞—Ñ—ã" class="stool-icon-img">
                    </div>
                    <div class="stool-btn-content">
                        <h3 class="stool-btn-title">–®—Ç—Ä–∞—Ñ—ã</h3>
                        <p class="stool-btn-description">–ö—Ç–æ-—Ç–æ –æ—Ñ–∏–≥–µ–ª? –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–∞—Ä–∫–æ–≤–∫—É</p>
                    </div>
                    <div class="stool-btn-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>

                <div class="stool-btn-wrapper" id="stool-geo-btn">
                    <div class="stool-btn-icon">
                        <img src="style/static/images/icons/geo.png" alt="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ" class="stool-icon-img">
                    </div>
                    <div class="stool-btn-content">
                        <h3 class="stool-btn-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ</h3>
                        <p class="stool-btn-description">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¢–°</p>
                    </div>
                    <div class="stool-btn-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="damage" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫</h1>
            </div>

            <div class="input-section">
                <div class="input-wrapper">
                    <input type="text" class="bike-input" id="bike-number" placeholder="–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –¢–°" maxlength="5" inputmode="numeric" pattern="[0-9]*">
                    <button class="qr-btn" id="scan-qr-btn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <path d="M10 3v4a1 1 0 0 1-1 1H3"/>
                            <path d="M14 21v-4a1 1 0 0 1 1-1h6"/>
                            <path d="M21 14h-4a1 1 0 0 1-1-1V3"/>
                            <path d="M3 10h4a1 1 0 0 1 1 1v10"/>
                        </svg>
                    </button>
                </div>
                <div class="error-message" id="number-error">–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –¢–°</div>
            </div>

            <div class="bike-section">
                <div class="bike-container">
                    <div id="bike-svg-container"></div>
                </div>
                <div class="damage-dropdown" id="damage-dropdown"></div>
            </div>

            <div class="selected-damages">
                <h2 class="section-title">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª–æ–º–∫–∏</h2>
                <div class="damages-list" id="damages-list">
                    <div class="empty-damages">–ü–æ–ª–æ–º–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                </div>
            </div>

            <div class="photo-section">
                <h2 class="section-title">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–ª–æ–º–∫–∏</h2>
                <div class="photo-container">
                    <div class="photos-preview-container" id="photos-preview-container">
                        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JS -->
                    </div>
                    <div class="photo-buttons">
                        <button class="take-photo-btn primary" id="take-photo-btn" style="background: var(--primary-text); color: var(--primary-bg); border-color: var(--primary-text);">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                        <div class="icon-buttons">
                            <button class="icon-btn" id="upload-photo-btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="location-info" id="location-info">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏</div>
                </div>
            </div>

            <div class="additional-info-section">
                <div class="input-block">
                    <textarea id="bike-additional-info"
                        class="styled-input auto-resize"
                        maxlength="200"
                        placeholder="–î–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –æ—Ç —Å–µ–±—è"></textarea>
                </div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" id="submit-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>

        <div class="camera-container" id="camera-container">
            <video id="camera-video" class="camera-video" autoplay playsinline></video>
            <div class="camera-controls">
                <button class="camera-btn" id="cancel-camera-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="camera-btn primary" id="capture-btn">–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
            </div>
        </div>

        <div class="camera-container" id="qr-scanner-container">
            <video id="qr-scanner-video" class="camera-video" autoplay playsinline></video>
                <div class="scanner-overlay">
                    <div class="scanner-frame"></div>
                </div>
                <div class="camera-controls">
                    <button class="camera-btn" id="cancel-qr-scan-btn">–û—Ç–º–µ–Ω–∞</button>
                </div>
        </div>
    </section>

    <section id="geo-update" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ</h1>
            </div>

            <div class="input-section">
                <div class="input-wrapper">
                    <input type="text" 
                        class="bike-input" 
                        id="geo-bike-input" 
                        placeholder="–ù–æ–º–µ—Ä–∞ –¢–°" 
                        maxlength="5" 
                        inputmode="numeric" 
                        pattern="[0-9]*">
                    <button class="qr-btn" id="geo-scan-qr-btn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <path d="M10 3v4a1 1 0 0 1-1 1H3"/>
                            <path d="M14 21v-4a1 1 0 0 1 1-1h6"/>
                            <path d="M21 14h-4a1 1 0 0 1-1-1V3"/>
                            <path d="M3 10h4a1 1 0 0 1 1 1v10"/>
                        </svg>
                    </button>
                    <button class="add-btn" id="geo-add-btn" title="–î–æ–±–∞–≤–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="geo-bikes-list-section" style="margin-bottom: 25px;">
                <h2 class="section-title">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –¢–° <span id="geo-bikes-count">(0 —à—Ç.)</span></h2>
                <div class="geo-bikes-list" id="geo-bikes-list">
                    <!-- JS -->
                    <div class="empty-list">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 10 —à—Ç—É–∫</div>
                </div>
            </div>

            <div class="coordinates-section" style="margin-bottom: 25px;">
                <h2 class="section-title">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏</h2>
                <div class="input-wrapper" style="margin-bottom: 15px;">
                    <input type="text" 
                        class="bike-input" 
                        id="geo-coordinates-input" 
                        placeholder="–°–∫–æ–ø–∏—Ä—É–π —Å –Ø.–ö–∞—Ä—Ç">
                </div>
                <button class="location-btn primary" id="get-location-btn" style="width: 100%; margin-bottom: 20px;">
                    <span class="btn-content">
                        <span class="btn-text">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
                    </span>
                </button>

                <div class="mini-map-container" id="mini-map-container" style="display: none;">
                    <img id="mini-map-image" src="" alt="–ö–∞—Ä—Ç–∞ —Å –º–µ—Ç–∫–æ–π" class="mini-map-image">
                    <div class="map-loading" id="map-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
                </div>
            </div>

            <div class="photo-section" style="margin-bottom: 25px;">
                <h2 class="section-title">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏</h2>
                <div class="photo-container">
                    <div class="photos-preview-container" id="geo-photos-preview-container">
                        <!-- JS -->
                    </div>
                    <div class="photo-buttons">
                        <button class="take-photo-btn" id="geo-take-photo-btn">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button class="submit-btn" id="geo-submit-btn" disabled>–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>

        <div class="camera-container" id="geo-qr-scanner-container">
            <video id="geo-qr-scanner-video" class="camera-video" autoplay playsinline></video>
            <div class="scanner-overlay">
                <div class="scanner-frame"></div>
            </div>
            <div class="scanner-controls">
                <div class="scanner-notice" id="scanner-notice">
                    –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
                </div>
                <div class="scanner-buttons">
                    <button class="scanner-btn primary" id="finish-geo-qr-scan-btn">
                        <span class="btn-text">–ì–æ—Ç–æ–≤–æ</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="camera-container" id="geo-camera-container">
            <video id="geo-camera-video" class="camera-video" autoplay playsinline></video>
            <div class="camera-controls">
                <button class="camera-btn" id="cancel-geo-camera-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="camera-btn primary" id="capture-geo-btn">–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
            </div>
        </div>
    </section>
    
    <section id="timestamp" class="page">
        <div class="container">
            <div class="timestamp-section">
                <div class="timestamp-mode-selector" style="display: none;">
                    <select class="mode-combobox" id="timestamp-mode">
                        <option value="normal">–û–±—ã—á–Ω–∞—è —Ñ–æ—Ç–∫–∞</option>
                        <option value="fine">–®—Ç—Ä–∞—Ñ –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É</option>
                    </select>
                </div>

                <div class="fine-form" id="fine-form">
                    <div class="fine-input-wrapper">
                        <input type="text" class="fine-bike-input" id="fine-bike-number" placeholder="–ù–æ–º–µ—Ä –¢–°" maxlength="5" inputmode="numeric">
                        <button class="fine-qr-btn" id="fine-scan-qr-btn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                                <path d="M10 3v4a1 1 0 0 1-1 1H3"/>
                                <path d="M14 21v-4a1 1 0 0 1 1-1h6"/>
                                <path d="M21 14h-4a1 1 0 0 1-1-1V3"/>
                                <path d="M3 10h4a1 1 0 0 1 1 1v10"/>
                            </svg>
                        </button>
                    </div>
                    <textarea id="fine-additional-info"
                        class="styled-input auto-resize"
                        maxlength="200"
                        placeholder="–î–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –æ—Ç —Å–µ–±—è"></textarea>
                    <div class="error-message" id="fine-number-error" style="margin-top: 10px;">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –¢–°</div>
                </div>

                <div class="timestamp-preview-container">
                    <div class="timestamp-preview" id="timestamp-preview">
                        <div class="timestamp-loading" id="timestamp-loading">
                            –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...
                        </div>
                        <video id="timestamp-video" style="display: none;" autoplay playsinline></video>
                        <canvas id="timestamp-canvas" style="display: none;"></canvas>
                        <img id="processed-photo-preview" class="processed-photo" style="display: none;" src="" alt="–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
                    </div>

                    <div class="timestamp-controls-overlay">
                        <div class="timestamp-controls" id="timestamp-controls">
                            <button class="timestamp-btn" id="timestamp-capture-btn" style="display: none;">
                                <span class="btn-content">
                                    <span class="btn-text">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</span>
                                </span>
                            </button>
                            
                            <div class="timestamp-result-controls" id="timestamp-result-controls" style="display: none;">
                                <button class="timestamp-btn primary" id="download-btn" style="display: none;">
                                    <span class="btn-content">
                                        <span class="btn-text">–°–∫–∞—á–∞—Ç—å</span>
                                    </span>
                                </button>
                                <button class="timestamp-btn" id="retake-btn">
                                    <span class="btn-content">
                                        <span class="btn-text">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</span>
                                    </span>
                                </button>
                                <button class="timestamp-btn primary" id="send-telegram-btn">
                                    <span class="btn-content">
                                        <span class="btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ–ª–µ–≥—É</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="van" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–§—É—Ä–≥–æ–Ω</h1>
                <p class="page-description">–≠—Ç–æ –¥–ª—è –≤–æ–¥–∏–ª, –∏–¥–µ–π–∫–∞ –µ—Å—Ç—å...</p>
            </div>
            <div class="under-construction">
                <h2>–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h2>
                <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è<br>—Ñ–∏–≥ –∑–Ω–∞–µ—Ç –∫–æ–≥–¥–∞</p>
            </div>
            <div class="pwa-promo" id="pwa-promo" style="display: none;">
                <div class="pwa-card">
                    <h3>–ë—Ä–∞—Ç–∞–Ω, —Å–∫–∞—á–∞–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                    <p>–¢–æ—Ç –∂–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –Ω–æ —Ç–∏–ø–∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—É—Å–∫, —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω, –Ω—É –∏ –∏–∫–æ–Ω–∫–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ</p>
                    <button class="pwa-install-btn" id="pwa-install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
                    <div class="pwa-instructions">
                        <p><strong>Android:</strong> –ú–µ–Ω—é ‚Üí "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</p>
                        <p><strong>iPhone:</strong> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="tasks" class="page">
        <div class="container">        
            <div class="quick-actions-section">
                <h2 class="section-title">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
                <div class="quick-actions-scroll">
                    <div class="quick-action-btn" data-action="relocation">
                        <div class="quick-action-icon">
                            <img src="style/static/images/icons/relocation.png" alt="–†–µ–ª–æ–∫–∞—Ü–∏—è">
                        </div>
                        <span class="quick-action-label">–†–µ–ª–æ–∫–∞—Ü–∏—è</span>
                    </div>
                    
                    <div class="quick-action-btn" data-action="order">
                        <div class="quick-action-icon">
                            <img src="style/static/images/icons/order.png" alt="–ü–æ—Ä—è–¥–æ–∫">
                        </div>
                        <span class="quick-action-label">–ü–æ—Ä—è–¥–æ–∫</span>
                    </div>
                    
                    <div class="quick-action-btn" data-action="timestamp">
                        <div class="quick-action-icon">
                            <img src="style/static/images/icons/timestamp.png" alt="TimeStamp">
                        </div>
                        <span class="quick-action-label">–§–æ—Ç–æ—á–∫–∞</span>
                    </div>
                </div>
            </div>
            
            <div class="tasks-list-section">
                <h2 class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
                <div class="tasks-list" id="tasks-list">
                    <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON -->
                    <div class="tasks-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
                </div>
            </div>
        </div>
        
        <div class="modal" id="task-modal">
            <div class="modal-content task-modal-content">                
                <div class="task-modal-image-container" id="task-modal-image-container">
                    <img id="task-modal-image" src="" alt="–§–æ—Ç–æ –∑–∞–¥–∞—á–∏" class="task-modal-image">
                    <div class="task-image-counter" id="task-image-counter"></div>
                    <button class="task-image-prev" id="task-image-prev">‚Üê</button>
                    <button class="task-image-next" id="task-image-next">‚Üí</button>
                </div>
                
                <span class="modal-close" id="task-modal-close">&times;</span>
                
                <div class="task-modal-body">
                    <div class="task-modal-header">
                        <h2 class="task-modal-title" id="task-modal-title"></h2>
                        <div class="task-modal-type" id="task-modal-type"></div>
                    </div>
                    
                    <div class="task-modal-description">
                        <p id="task-modal-full-description"></p>
                    </div>
                    
                    <div class="task-modal-details">
                        <div class="detail-item" id="task-bike-number-item">
                            <span class="detail-label">–ù–æ–º–µ—Ä –¢–°:</span>
                            <span class="detail-value" id="task-modal-bike-number"></span>
                        </div>
                        <div class="detail-item" id="task-address-item">
                            <span class="detail-label">–ê–¥—Ä–µ—Å:</span>
                            <span class="detail-value" id="task-modal-address"></span>
                        </div>
                        <div class="detail-item" id="task-zone-item">
                            <span class="detail-label">–ó–æ–Ω–∞:</span>
                            <span class="detail-value" id="task-modal-zone"></span>
                        </div>
                        <div class="detail-item" id="task-coords-item">
                            <span class="detail-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</span>
                            <span class="detail-value" id="task-modal-coords"></span>
                        </div>
                    </div>
                    
                    <div class="task-modal-actions">
                        <button class="task-modal-btn primary" id="task-navigate-btn">
                            <span class="btn-content">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <span class="btn-text">–ü–æ–µ—Ö–∞–ª–∏</span>
                            </span>
                        </button>
                        <button class="task-modal-btn" id="task-complete-btn">
                            <span class="btn-content">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                <span class="btn-text">–ì–æ—Ç–æ–≤–æ</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="profile" class="page">
        <div class="container">
            <div class="header">
                <h1 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</h1>
                <p class="page-description">–ö–ª–∞—Å—Å–Ω–æ –≤—ã–≥–ª—è–¥–∏—à—å</p>
            </div>

            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="profile-avatar">–ü</div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-name-row">
                            <h2 class="profile-name" id="profile-name"></h2>
                            <button class="info-btn" id="profile-info-btn" title="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                                i
                            </button>
                        </div>
                        <div class="profile-details">
                            <div class="profile-detail">
                                <span class="detail-label">–†–æ–ª—å:</span>
                                <span class="detail-value" id="profile-role"></span>
                            </div>
                            <div class="profile-detail">
                                <span class="detail-label">–Æ–∑:</span>
                                <span class="detail-value" id="profile-username"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="balance-section">
                <div class="balance-row">
                    <span class="balance-label">–ë–∞–ª–∞–Ω—Å:</span>
                    <span class="balance-value" id="profile-balance">17 –±–∞–ª–ª–æ–≤</span>
                </div>
            </div>

            <div class="achievements-section">
                <button class="achievement-btn" id="achievement-btn">
                    <span class="btn-text">–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span>
                    <span class="btn-arrow">‚Üí</span>
                </button>
            </div>

            <div class="requests-history">
                <button class="history-btn" id="requests-history-btn">
                    <span class="btn-text">–ò—Å—Ç–æ—Ä–∏—è –º–æ–∏—Ö –∑–∞—è–≤–æ–∫</span>
                    <span class="btn-arrow">‚Üí</span>
                </button>
            </div>

            <!-- –†–ï–î–ê–ö–¢–û–† –î–ï–ú–û-–Æ–ó–ï–†–ê -->
            <div class="demo-editor-section">
                <div class="section-header">
                    <h3 class="section-title">–†–µ–¥–∞–∫—Ç–æ—Ä –¥–µ–º–æ-—é–∑–µ—Ä–∞</h3>
                </div>
                
                <div class="demo-editor-form">
                    <div class="input-block">
                        <label class="input-label">ID Velobike</label>
                        <input type="number" id="demo-id" class="styled-input" value="0" min="0">
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–ò–º—è</label>
                        <input type="text" id="demo-first-name" class="styled-input" value="–î–µ–º–æ">
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" id="demo-last-name" class="styled-input" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–†–æ–ª—å</label>
                        <select id="demo-role" class="styled-input">
                            <option value="scout">scout (–°–∫–∞—É—Ç)</option>
                            <option value="charger">charger (–ß–∞—Ä–¥–∂–µ—Ä)</option>
                            <option value="driver">driver (–í–æ–¥–∏—Ç–µ–ª—å)</option>
                        </select>
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–°—Ç–∞—Ç—É—Å —Å–ª–æ—Ç–∞</label>
                        <select id="demo-slot-status" class="styled-input">
                            <option value="inactive">inactive (–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)</option>
                            <option value="pending">pending (–≤–æ—Ç-–≤–æ—Ç –Ω–∞—á–Ω–µ—Ç—Å—è)</option>
                            <option value="active">active (—Å–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω)</option>
                        </select>
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–ó–æ–Ω–∞ —Å–ª–æ—Ç–∞</label>
                        <input type="text" id="demo-slot-zone" class="styled-input" value="3–´">
                    </div>
                    
                    <div class="input-block">
                        <label class="input-label">–ë–∞–ª–∞–Ω—Å (–±–∞–ª–ª—ã)</label>
                        <input type="number" id="demo-balance" class="styled-input" value="17" min="0">
                    </div>
                    
                    <div class="demo-editor-buttons">
                        <button class="modal-btn primary" id="demo-save-btn">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                    </div>
                    
                    <div class="demo-hint">
                        –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–µ—Ä–Ω—É—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω.
                    </div>
                </div>
            </div>

            <div class="version-footer">
                <div class="version-text" id="profile-version">–í–µ—Ä—Å–∏—è: 0.1.2 Beta</div>
            </div>
        </div>

        <div class="modal" id="profile-details-modal">
            <div class="modal-content">
                <span class="modal-close" id="profile-modal-close">&times;</span>
                <h2 class="modal-title">–î–µ—Ç–∞–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                
                <div class="details-table">
                    <div class="detail-row">
                        <span class="detail-key">ID Velobike:</span>
                        <span class="detail-value" id="modal-velobike-id">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-key">Role:</span>
                        <span class="detail-value" id="modal-role">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-key">ID Telegram:</span>
                        <span class="detail-value" id="modal-telegram-id">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-key">Balance:</span>
                        <span class="detail-value" id="modal-balance">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-key">Created at:</span>
                        <span class="detail-value" id="modal-created-at">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-key">Launch mode:</span>
                        <span class="detail-value" id="modal-launch-mode">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</span>
                    </div>
                </div>
                
                <button class="modal-btn" id="profile-modal-ok">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </section>

    <div class="notification" id="notification"></div>

    <nav class="bottom-nav">
        <div class="nav-item" data-page="main">
            <div class="nav-icon">
                <img src="style/static/images/icons/main.png" alt="–ì–ª–∞–≤–Ω–∞—è">
            </div>
            <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" data-page="slots" id="slots-nav-item" style="display: none;">
            <div class="nav-icon">
                <img src="style/static/images/icons/slot.png" alt="–°–ª–æ—Ç—ã">
            </div>
            <span class="nav-label">–°–ª–æ—Ç—ã</span>
        </div>
        <div class="nav-item" data-page="tasks">
            <div class="nav-icon">
                <img src="style/static/images/icons/missions.png" alt="–ó–∞–¥–∞—á–∏">
            </div>
            <span class="nav-label">–ó–∞–¥–∞—á–∏</span>
        </div>
        <div class="nav-item" data-page="stool">
            <div class="nav-icon">
                <img src="style/static/images/icons/tabouret.png" alt="–¢–∞–±—É—Ä–µ—Ç">
            </div>
            <span class="nav-label">–¢–∞–±—É—Ä–µ—Ç</span>
        </div>
        <div class="nav-item" data-page="van">
            <div class="nav-icon">
                <img src="style/static/images/icons/van.png" alt="–§—É—Ä–≥–æ–Ω">
            </div>
            <span class="nav-label">–§—É—Ä–≥–æ–Ω</span>
        </div>
        <div class="nav-item" data-page="profile">
            <div class="nav-icon">
                <img src="style/static/images/icons/profile.png" alt="–ü—Ä–æ—Ñ–∏–ª—å">
            </div>
            <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

        <div class="modal" id="confirmation-modal">
            <div class="modal-content">
                <span class="modal-close" id="modal-close">&times;</span>
                <h2 class="modal-title">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</h2>
                <p class="modal-text">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Ññ<span id="bike-number-confirm"></span> —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –õ—ë—Ö–µ.</p>
                <button class="modal-btn" id="modal-ok-btn">–•–æ—Ä–æ—à–æ</button>
            </div>
        </div>

        <div class="modal" id="fine-confirmation-modal">
            <div class="modal-content">
                <span class="modal-close" id="fine-modal-close">&times;</span>
                <h2 class="modal-title">–®—Ç—Ä–∞—Ñ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</h2>
                <p class="modal-text">–®—Ç—Ä–∞—Ñ –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ <span id="fine-bike-number-confirm"></span> —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.</p>
                <button class="modal-btn" id="fine-modal-ok-btn">–•–æ—Ä–æ—à–æ</button>
            </div>
        </div>

        <div class="modal" id="section-info-modal">
            <div class="modal-content">
                <div class="section-info-icon" id="section-info-icon">üö≤</div>
                <h2 class="section-info-title" id="section-info-title">–†–∞–∑–¥–µ–ª</h2>
                <p class="section-info-description" id="section-info-description">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                <button class="modal-btn" id="section-info-close">–ü–æ–Ω—è–ª</button>
            </div>
        </div>

        <div class="modal" id="geo-confirmation-modal">
            <div class="modal-content">
                <span class="modal-close" id="geo-modal-close">&times;</span>
                <h2 class="modal-title">–ü–æ–±–µ–¥–∞</h2>
                <p class="modal-text">–ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.</p>
                <button class="modal-btn" id="geo-modal-ok-btn">–•–æ—Ä–æ—à–æ</button>
            </div>
        </div>

        <div id="loading-screen" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
            ">
            <div class="loading-logo" style="margin-bottom: 30px;">
                <img src="style/static/images/logo128.png" 
                        alt="Velobike" 
                        style="width: 80px; height: 80px; object-fit: contain;">
            </div>
            <div class="loading-text" style="
                font-size: 18px;
                color: #fff;
                margin-bottom: 30px;
            ">
                –ü–æ–≥–æ–¥–∏, –∑–∞–≥—Ä—É–∑–∫–∞...
            </div>
            <div class="loading-spinner" style="
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            "></div>
            </div>

            <style>
            @keyframes spin {
            to { transform: rotate(360deg); }
            }
            </style>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
    let currentBikeNumber = '';
    let selectedDamages = [];
    let currentPart = null;
    let telegramWebApp = null;
    let damageData = {};
    let currentPhotos = [];
    let userLocation = null;
    let userData = null;
    let qrScannerStream = null;
    let qrScanInterval = null;

    let timestampStream = null;
    let timestampCanvas = null;
    let timestampContext = null;
    let timestampState = 'initial';
    let cameraPermissionGranted = false;
    let geoPermissionGranted = false;
    let currentProcessedPhoto = null;
    let userCoords = null;
    let userAddress = null;
    let locationReceived = false;
    let isTimestampInitialized = false;
    let collectedCoordinates = [];
    const MAX_COORDINATES = 10;

    let geoWatchId = null;
    let torchStream = null;
    let isTorchOn = false;

    const telegramBotToken = '8201906085:AAGubVZkazSCTTK7xI_r9NXVa73LX-_3ND8'; // —ç—Ç–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø, –Ω–µ —Ç—Ä–æ–≥–∞–π –ø–ª–∏–∑
    const telegramChatId = '-1002981629310';
    const TIMESTAMP_TOPIC_ID = 22;
    const DAMAGES_TOPIC_ID = 11;
    const FINE_TOPIC_ID = 15;

    let currentTasks = [];
    let currentTaskImages = [];
    let currentImageIndex = 0;

    let selectedDate = null;
    let selectedZone = null;
    let zonesData = {};

    let geoCurrentBikeNumber = '';
    let geoCurrentPhotos = [];
    let geoUserLocation = null;
    let geoScannerStream = null;
    let geoCameraStream = null;
    let geoQrScanInterval = null;

    let demoUserData = null;
    let appInitialized = false;
    
    let longPressTimer;
    const longPressDuration = 500;
    let deferredPrompt;
    let lastScannedBike = null;
    let lastScanTime = 0; 
    
    
    // APP.JS - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—â–µ–µ
        
    async function initializeApp() {
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                telegramWebApp = window.Telegram.WebApp;
                
                try {
                    telegramWebApp.ready();
                    telegramWebApp.expand();
                    
                    if (telegramWebApp.initDataUnsafe && telegramWebApp.initDataUnsafe.user) {
                        const telegramUser = telegramWebApp.initDataUnsafe.user;
                        
                        userData = {
                            id: 1,
                            first_name: telegramUser.first_name || 'Telegram',
                            last_name: telegramUser.last_name || 'User',
                            role: 'scout',
                            telegram_id: telegramUser.id,
                            username: telegramUser.username || `user${telegramUser.id}`,
                            technical_login: `tg${telegramUser.id}`,
                            slot_status: 'inactive',
                            balance: 0,
                            slot_zone: '',
                            created_at: new Date().toISOString(),
                            last_active: new Date().toISOString()
                        };
                        
                        console.log('–î–∞–Ω–Ω—ã–µ Telegram –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', telegramUser);
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
                }
            }
            
            if (!userData) {
                userData = await loadDemoUserData();
            }
            
            await Promise.all([
                loadDamageData(),
                loadZonesData(),
                loadTasks()
            ]);
            
            setupNavigationForRole(userData);
            updateShiftStatusUI(userData);
            
            initializeModules();
            
            setTimeout(() => {
                hideLoadingScreen();
                appInitialized = true;
            }, 1000);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            showErrorScreen();
        }
    }

    function updateUserFromTelegram() {
        if (!telegramWebApp || !telegramWebApp.initDataUnsafe || !telegramWebApp.initDataUnsafe.user) {
            return;
        }
        
        const telegramUser = telegramWebApp.initDataUnsafe.user;
        
        if (telegramUser && telegramUser.id) {
            if (telegramUser.first_name) userData.first_name = telegramUser.first_name;
            if (telegramUser.last_name) userData.last_name = telegramUser.last_name;
            if (telegramUser.username) userData.username = telegramUser.username;
            
            userData.telegram_id = telegramUser.id;
            
            updateProfileInfo();
        }
    }

    async function loadDemoUserData() {
        try {
            const savedDemo = localStorage.getItem('demoUser');
            if (savedDemo) {
                return JSON.parse(savedDemo);
            }
            
            const response = await fetch('style/static/lists/demo-user.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const userData = await response.json();
            
            localStorage.setItem('demoUser', JSON.stringify(userData));
            
            return userData;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö:', error);
            
            const defaultUser = {
                id: 1,
                first_name: "–ì–æ—Å—Ç—å",
                last_name: "",
                role: "scout",
                telegram_id: 0,
                username: "guest",
                technical_login: "guest123",
                slot_status: "inactive",
                balance: 0,
                slot_zone: "",
                created_at: new Date().toISOString(),
                last_active: new Date().toISOString()
            };
            
            localStorage.setItem('demoUser', JSON.stringify(defaultUser));
            return defaultUser;
        }
    }

    function setupNavigationForRole(userData) {        
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            item.style.display = 'none';
        });
        
        const sectionsToShow = getSectionsForRole(userData);
        
        sectionsToShow.forEach(sectionId => {
            const navItem = document.querySelector(`.nav-item[data-page="${sectionId}"]`);
            if (navItem) {
                navItem.style.display = 'flex';
            }
        });
        
        switchPage('main');
    }

    function getSectionsForRole(userData) {
        const baseSections = ['main', 'stool', 'profile'];
            
        if (shouldShowSlots()) {
            baseSections.splice(1, 0, 'slots');
        }
            
        if (userData.role === 'scout' || userData.role === 'charger') {
            const sections = [...baseSections]

            if (userData.slot_status == "active") {
                const tasksIndex = sections.indexOf('stool');
                sections.splice(tasksIndex, 0, 'tasks');
            }

            return sections;

        } else if (userData.role === 'driver') {
            const sections = [...baseSections];
                
            if (userData.slot_status == "active") {
                const tasksIndex = sections.indexOf('stool');
                sections.splice(tasksIndex, 0, 'tasks');

                const vanIndex = sections.indexOf('tasks') + 1;
                sections.splice(vanIndex, 0, 'van');
            }
                
            return sections;
        }
        
        return baseSections;
    }

    function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
            loadingScreen.style.display = 'none';
            }, 300);
        }
    }

    function showErrorScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h2 style="color: #fff; margin-bottom: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                <p style="color: #ccc; margin-bottom: 20px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                <button onclick="location.reload()" style="
                padding: 12px 24px;
                background: #fff;
                color: #000;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                ">
                –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
            </div>
            `;
        }
    }

    function updateShiftStatusUI(userData) {}

    function initializeModules() {
        initCamera();
        initQRScanner();
        initTimestampCanvas();
        initTimestampEventListeners();
        
        const accessiblePages = Array.from(document.querySelectorAll('.page:not(.role-restricted)'))
            .map(page => page.id);
        
        if (accessiblePages.includes('damage')) {
            loadBikeSVG();
        }
        
        if (accessiblePages.includes('slots')) {
            initSlotsPage();
        }
        
        if (accessiblePages.includes('tasks')) {
            loadTasks();
        }
    }

    function isInTelegram() {
        if (window.Telegram && window.Telegram.WebApp) {
            const webApp = window.Telegram.WebApp;
            
            if (webApp.initData || webApp.initDataUnsafe) {
                if (webApp.platform && webApp.platform !== 'unknown') {
                    return true;
                }
                
                if (webApp.initData) {
                    return true;
                }
                
                if (webApp.initDataUnsafe && webApp.initDataUnsafe.user) {
                    return true;
                }
            }
            
            if (webApp.version) {
                const userAgent = navigator.userAgent.toLowerCase();
                if (userAgent.includes('telegram') || userAgent.includes('webview')) {
                    return true;
                }
            }

            telegramWebApp.onEvent('viewportChanged', updateUserFromTelegram);
        }
        
        return false;
    }

    function isDebugMode() {
        return window.location.hostname === '127.0.0.1';
    }

    function shouldShowSlots() {
        return true;
    }

    function getLaunchMode() {
        if (isPWAInstalled()) {
            return 'PWA (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)';
        }
        
        if (isInTelegram()) {
            return 'Telegram Mini App';
        }
        
        if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
            return '–í–µ–±-—Å–∞–π—Ç (—Ä–∞–∑—Ä–∞–±)';
        }
        
        return '–í–µ–±-—Å–∞–π—Ç';
    }

    // MAIN-PAGE.JS

    function initMainPage() {
        updateWelcomeInfo();
        updateShiftNotification();
        loadImportantNews();
        setupMainPageListeners();
    }
    
    function updateWelcomeInfo() {
        const nameElement = document.getElementById('user-name');
        if (nameElement && userData) {
            const firstName = userData.first_name;
            nameElement.textContent = firstName;
        }
        
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            const now = new Date();
            const days = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
            const months = [
                '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
            ];
            
            const dayOfWeek = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            
            dateElement.textContent = `–°–µ–≥–æ–¥–Ω—è ${day} ${month}, ${dayOfWeek}`;
        }
    }

    function updateShiftNotification() {
        const notification = document.getElementById('shift-notification');
        if (!notification || !userData) return;
        
        if (userData.slot_status === 'pending' && isSlotStartingSoon())
        {
            const shouldShowNotification = true;
            
            if (shouldShowNotification) {
                notification.style.display = 'block';
                
                const title = notification.querySelector('.shift-title');
                const description = notification.querySelector('.shift-description');
                const button = document.getElementById('start-shift-btn');
                
                if (title) title.textContent = '–û–ø–∞, —Å–ª–æ—Ç –≤–æ—Ç-–≤–æ—Ç –Ω–∞—á–Ω–µ—Ç—Å—è!';
                if (description) description.textContent = '–¢—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å–≤–æ–π —Å–ª–æ—Ç';
                if (button) button.textContent = '–ù–∞—á–∞—Ç—å —Å–ª–æ—Ç';
            } else {
                notification.style.display = 'none';
            }
        }
    }

    function isSlotStartingSoon() {
        return true;
    }

    function isShiftStartingSoon(shiftTime) {
        if (!shiftTime) return false;
        
        const shiftStart = new Date(shiftTime);
        const now = new Date();
        const timeUntilShift = shiftStart.getTime() - now.getTime();
        
        return timeUntilShift > 0 && timeUntilShift <= 30 * 60 * 1000;
    }
    
    async function loadImportantNews() {
        const newsList = document.getElementById('news-list');
        if (!newsList) return;
        
        try {
            const response = await fetch('style/static/lists/news.json');
            const data = await response.json();

            renderNews(data.news.filter(item => item.visible !== false));
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
            showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π");
        }
    }
    
    function renderNews(newsItems) {
        const newsList = document.getElementById('news-list');
        if (!newsList) return;
        
        if (!newsItems || newsItems.length === 0) {
            newsList.innerHTML = '<div class="news-loading">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
            return;
        }
        
        const priorityOrder = { high: 1, medium: 2, low: 3 };
        const sortedNews = [...newsItems].sort((a, b) => {
            return priorityOrder[a.priority || 'low'] - priorityOrder[b.priority || 'low'];
        });
        
        newsList.innerHTML = sortedNews.map(news => `
            <div class="news-item ${news.priority || 'low'}-priority" data-news-id="${news.id}">
                <div class="news-item-content">
                    <div class="news-item-icon">${news.icon || 'üì¢'}</div>
                    <div class="news-item-text">
                        <h4 class="news-item-title">${news.title}</h4>
                        <p class="news-item-description">${news.description}</p>
                        ${news.date ? `<div class="news-item-date">${formatNewsDate(news.date)}</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        document.querySelectorAll('.news-item').forEach(item => {
            item.addEventListener('click', handleNewsClick);
        });
    }
    
    function formatNewsDate(dateString) {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
        if (diffDays === 1) return '–í—á–µ—Ä–∞';
        if (diffDays < 7) return `${diffDays} –¥–Ω—è –Ω–∞–∑–∞–¥`;
        
        return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
    }
    
    function handleNewsClick(event) {
        const newsItem = event.currentTarget;
        const newsId = parseInt(newsItem.dataset.newsId);
        
        showNotification('–ù–æ–≤–æ—Å—Ç—å ‚Ññ' + newsId);
    }

    function setupMainPageListeners() {
        const startShiftBtn = document.getElementById('start-shift-btn');
        if (startShiftBtn) {
            startShiftBtn.addEventListener('click', function() {
                if (userData && userData.slot_status == "active") {
                    switchPage('tasks');
                } else {
                    switchPage('slots');
                }
            });
        }
        
        const refreshBtn = document.getElementById('refresh-news-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async function() {
                this.classList.add('rotate-once');
                
                await loadImportantNews();
                
                setTimeout(() => {
                    this.classList.remove('rotate-once');
                }, 500);
            });
        }
    }


    // NAVIGATION.JS

    function switchPage(pageId) {
        const targetPage = document.getElementById(pageId);
                
        stopAllCameras();

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        if (targetPage) {
            targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }

        if (pageId === 'main') {
            setTimeout(() => {
                initMainPage();
                checkAndShowPWAPromo();
            }, 100);
        }

        if (pageId !== 'timestamp') {
            stopAllCameras();
        }

        if (pageId === 'profile') {
            setTimeout(() => {
                initProfilePage();
            }, 100);
        }
        
        if (pageId === 'geo-update') {
            setTimeout(() => {
                initGeoUpdatePage();
            }, 100);
        }

        if (pageId === 'damage') {
            setTimeout(centerBikeSVG, 100);
        }

        if (pageId === 'timestamp') {
            setTimeout(() => {
                initTimestampCanvas();
                initTimestampEventListeners();
                
                if (!timestampStream && timestampState === 'initial') {
                    startTimestampProcess();
                }
                
                updateTimestampUI();
                isTimestampInitialized = true;
            }, 100);
        }
        
        if (pageId === 'slots') {
            setTimeout(() => {
                initSlotsPage();
            }, 100);
        }

        if (pageId === 'tasks') {
            setTimeout(() => {
                initTasksPage();
            }, 100);
        }
        
        if (pageId !== 'main' || isInTelegram()) {
            document.getElementById('pwa-promo').style.display = 'none';
        } else {
            checkAndShowPWAPromo();
        }
    }

    function setupLongPress() {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('touchstart', function(e) {
                const pageId = this.getAttribute('data-page');
                longPressTimer = setTimeout(() => {
                    showSectionInfo(pageId);
                }, longPressDuration);
            });
            
            item.addEventListener('touchend', function() {
                clearTimeout(longPressTimer);
            });
            
            item.addEventListener('touchmove', function() {
                clearTimeout(longPressTimer);
            });
            
            item.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');
                showSectionInfo(pageId);
            });
        });

        document.getElementById('section-info-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    }

    function showSectionInfo(pageId) {
        const modal = document.getElementById('section-info-modal');
        const icon = document.getElementById('section-info-icon');
        const title = document.getElementById('section-info-title');
        const description = document.getElementById('section-info-description');
        
        const sectionInfo = {
            'main': { 
                icon: '<img src="style/static/images/icons/main.png" alt="–ì–ª–∞–≤–Ω–∞—è" style="width: 48px; height: 48px;">', 
                title: '–ì–ª–∞–≤–Ω–∞—è', 
                description: '–¢—É—Ç —É –Ω–∞—Å –±—É–¥–µ—Ç –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å :)' 
            },
            'slots': { 
                icon: '<img src="style/static/images/icons/slot.png" alt="–°–ª–æ—Ç—ã" style="width: 48px; height: 48px;">', 
                title: '–°–ª–æ—Ç—ã', 
                description: '–î–∞-–¥–∞, —Å–∏—Å—Ç–µ–º–∞ —Å–ª–æ—Ç–æ–≤ —É–∂–µ —Ç—É—Ç' 
            },
            'damage': { 
                icon: '<img src="style/static/images/icons/damage.png" alt="–ü–æ–ª–æ–º–∫–∏" style="width: 48px; height: 48px;">', 
                title: '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫', 
                description: '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –≤ —Ä–µ–º–æ–Ω—Ç —Å—Ä–∞–∑—É –æ—Ç—Å—é–¥–∞, –±–µ–∑ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è' 
            },
            'timestamp': { 
                icon: '<img src="style/static/images/icons/timestamp.png" alt="TimeStamp" style="width: 48px; height: 48px;">', 
                title: 'TimeStamp Camera', 
                description: '–ò —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—è, –∏ —Ñ–∏–∫—Å–∞—Ü–∏—è —à—Ç—Ä–∞—Ñ–æ–≤)' 
            },
            'tasks': { 
                icon: '<img src="style/static/images/icons/missions.png" alt="–ó–∞–¥–∞—á–∏" style="width: 48px; height: 48px;">', 
                title: '–ó–∞–¥–∞—á–∏', 
                description: '–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞—á–∏. –û–∫–µ–π?' 
            },
            'stool': { 
                icon: '<img src="style/static/images/icons/tabouret.png" alt="–¢–∞–±—É—Ä–µ—Ç" style="width: 48px; height: 48px;">', 
                title: '–¢–∞–±—É—Ä–µ—Ç', 
                description: '–ü—É –ø—É –ø—É—É' 
            },
            'van': { 
                icon: '<img src="style/static/images/icons/van.png" alt="–§—É—Ä–≥–æ–Ω" style="width: 48px; height: 48px;">', 
                title: '–§—É—Ä–≥–æ–Ω', 
                description: '–í—Å–µ, —á—Ç–æ —É —Ç–µ–±—è –≤ —Ñ—É—Ä–≥–æ–Ω–µ ‚Äî —Ç—É—Ç' 
            },
            'profile': { 
                icon: '<img src="style/static/images/icons/profile.png" alt="–ü—Ä–æ—Ñ–∏–ª—å" style="width: 48px; height: 48px;">', 
                title: '–ü—Ä–æ—Ñ–∏–ª—å', 
                description: '–¢—É—Ç –±—É–¥–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, –Ω–æ —ç—Ç–æ –Ω–µ —Å–∫–æ—Ä–æ...' 
            }
        };
        
        const info = sectionInfo[pageId] || sectionInfo.main;
    
        icon.innerHTML = info.icon;
        title.textContent = info.title;
        description.textContent = info.description;
        
        const closeBtn = document.getElementById('section-info-close');
        closeBtn.onclick = null;
        modal.onclick = null;
        
        modal.classList.add('active');
        
        function closeModal() {
            hideModal(modal);
        }

        closeBtn.onclick = closeModal;
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeModal();
            }
        };
    }

    function stopAllCameras() {
        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }
        
        if (qrScannerStream) {
            try {
                qrScannerStream.getTracks().forEach(track => track.stop());
            } catch(e) {}
            qrScannerStream = null;
        }
        
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        if (qrScannerContainer && qrScannerContainer.classList.contains('active')) {
            qrScannerContainer.classList.remove('active');
        }
        
        if (timestampStream) {
            try {
                timestampStream.getTracks().forEach(track => track.stop());
            } catch(e) {}
            timestampStream = null;
        }
        
        const cameraContainer = document.getElementById('camera-container');
        if (cameraContainer && cameraContainer.classList.contains('active')) {
            const video = document.getElementById('camera-video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            cameraContainer.classList.remove('active');
        }
        
        stopGeoCollection();
        
        if (timestampState !== 'initial') {
            timestampState = 'initial';
            updateTimestampUI();
        }
        
        turnOffTorch();
    }


    //SLOTS-PAGE.JS

    function initSlotsPage() {
        if (!shouldShowSlots()) {
            const slotsNav = document.querySelector('.nav-item[data-page="slots"]');
            if (slotsNav) slotsNav.style.display = 'none';
            return;
        }
        
        loadZonesData();
        loadZonesSVG();
        generateCalendar();
        
        document.getElementById('send-slot-btn').addEventListener('click', sendSlotToTelegram);
        
        document.getElementById('cancel-zone-btn').addEventListener('click', resetSlotForm);

        document.getElementById('past-slots-btn').addEventListener('click', function() {
            loadPastSlots();
        });
    }

    async function loadZonesData() {
        try {
            const response = await fetch('style/static/lists/zones.json');
            zonesData = await response.json();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–æ–Ω');
            zonesData = { zones: {} };
        }
    }

    async function loadZonesSVG() {
        try {
            const response = await fetch('style/static/models/mapszonescout.svg');
            const svgText = await response.text();
            const svgContainer = document.getElementById('zones-svg-container');
            svgContainer.innerHTML = svgText;
            
            const svg = svgContainer.querySelector('svg');
            if (svg) {
                svg.classList.add('zones-svg');
            }
            
            setTimeout(() => {
                setupZonesInteractivity();
            }, 100);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SVG –∫–∞—Ä—Ç—ã –∑–æ–Ω');
            loadZonesFallback();
        }
    }

    function loadZonesFallback() {
        const svgContainer = document.getElementById('zones-svg-container');
        svgContainer.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 18px; margin-bottom: 10px;">–ö–∞—Ä—Ç–∞ –∑–æ–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
                <div style="font-size: 14px; color: #ccc;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–æ–Ω –Ω–∏–∂–µ</div>
            </div>
        `;
    }

    function setupZonesInteractivity() {
        const zones = document.querySelectorAll('.slot-zone');
        zones.forEach(zone => {
            zone.style.webkitTapHighlightColor = 'transparent';
            zone.style.outline = 'none';
            
            zone.addEventListener('click', handleZoneClick);
            zone.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleZoneClick(e);
            });
        });
    }

    function handleZoneClick(event) {
        event.preventDefault();
        event.stopPropagation();

        const zoneElement = event.currentTarget.closest('.slot-zone');
        if (!zoneElement) return;
        
        const zoneId = zoneElement.id.replace('zone-', '');
        
        document.querySelectorAll('.slot-zone').forEach(z => z.classList.remove('active'));
        
        zoneElement.classList.add('active');
        
        selectedZone = zoneId;
        showZoneConfirmation(zoneId);
    }

    function showZoneConfirmation(zoneId) {
        if (!zonesData.zones[zoneId]) return;
        
        const zone = zonesData.zones[zoneId];
        const confirmationSection = document.querySelector('.zone-confirmation-section');
        
        document.getElementById('zone-name-span').textContent = zone.name;
        
        const districtsList = document.getElementById('zone-districts-list');
        districtsList.innerHTML = `<ul>${zone.districts.map(district => `<li>${district}</li>`).join('')}</ul>`;
        
        confirmationSection.style.display = 'block';
        confirmationSection.style.opacity = '0';
        confirmationSection.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            confirmationSection.style.transition = 'all 0.5s ease';
            confirmationSection.style.opacity = '1';
            confirmationSection.style.transform = 'translateY(0)';
        }, 10);
        
        setTimeout(() => {
            confirmationSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }

    function formatDateHuman(date) {
        const months = [
            '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
            '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
        ];
        
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        
        return `${day} ${month} ${year}–≥.`;
    }

    function generateCalendar() {
        const calendarDays = document.getElementById('calendar-days');
        const monthDisplay = document.getElementById('calendar-month');
        
        calendarDays.innerHTML = '';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const startDate = new Date(today);
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 13);
        
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        
        monthDisplay.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
        
        const firstDay = new Date(startDate);
        const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendarDays.appendChild(emptyDay);
        }
        
        let daysGenerated = 0;
        const maxDays = 14;

        for (let i = 0; i < maxDays; i++) {
            const dayDate = new Date(startDate);
            dayDate.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day available';
            dayElement.textContent = dayDate.getDate();
            dayElement.dataset.date = dayDate.toISOString().split('T')[0];
            dayElement.dataset.dayIndex = i;
            
            if (dayDate.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            } else {
                dayElement.classList.remove('today');
            }
            
            if (selectedDate && dayDate.toDateString() === new Date(selectedDate).toDateString()) {
                dayElement.classList.add('selected');
                dayElement.classList.remove('today');
            }
            
            if (dayDate < today) {
                dayElement.classList.remove('available');
                dayElement.classList.add('past');
            }
            
            dayElement.addEventListener('click', () => {
                if (dayElement.classList.contains('past') || 
                    dayElement.classList.contains('unavailable')) {
                    return;
                }
                selectDate(new Date(dayDate));
            });
            
            calendarDays.appendChild(dayElement);
        }
    }

    function selectDate(date) {
        
        document.querySelectorAll('.calendar-day.selected').forEach(d => {
            d.classList.remove('selected');
        });
        
        const todayElement = document.querySelector('.calendar-day.today');
        if (todayElement) {
            todayElement.classList.remove('today');
        }
        
        const dateStr = date.toISOString().split('T')[0];
        
        const dayElement = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
        if (dayElement) {
            dayElement.classList.add('selected');
        }
        
        selectedDate = new Date(date);
        
        const zonesSection = document.querySelector('.zones-section');
        zonesSection.style.display = 'block';
        zonesSection.style.opacity = '0';
        zonesSection.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            zonesSection.style.transition = 'all 0.5s ease';
            zonesSection.style.opacity = '1';
            zonesSection.style.transform = 'translateY(0)';
        }, 10);
        
        document.querySelector('.zone-confirmation-section').style.display = 'none';
        
        selectedZone = null;
        document.querySelectorAll('.slot-zone').forEach(z => z.classList.remove('active'));
        
        const formattedDate = formatDateHuman(date);
    }

    async function sendSlotToTelegram() {
        if (!selectedDate || !selectedZone || !zonesData.zones[selectedZone]) {
            showNotification('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –∑–æ–Ω—É');
            return;
        }
        
        const sendBtn = document.getElementById('send-slot-btn');
        sendBtn.disabled = true;
        const originalText = sendBtn.textContent;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        
        try {
            let username = '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
            
            if (userData && userData.id) {
                username = userData.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userData.id}`;
            } else if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
                username = telegramUser.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${telegramUser.id}`;
            }
            
            const date = new Date(selectedDate);
            const formattedDate = formatDateHuman(date);
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const zoneName = zonesData.zones[selectedZone].name;
            
            const messageText = `@${username} —Ö–æ—á–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç.\n\n` +
                              `–î–∞—Ç–∞: ${formattedDate}\n` +
                              `–ó–æ–Ω–∞: ${zoneName}\n\n` +
                              `–ó–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${timeString}`;
            
            const formData = new FormData();
            formData.append('chat_id', telegramChatId);
            formData.append('message_thread_id', '7');
            formData.append('text', messageText);
            
            const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (!result.ok) throw new Error(result.description || 'Telegram API error');
            
            showNotification('–ó–∞—è–≤–∫–∞ –Ω–∞ —Å–ª–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            resetSlotForm();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–ª–æ—Ç:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = originalText;
        }
    }

    function resetSlotForm() {
        selectedDate = null;
        selectedZone = null;
        
        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
        document.querySelectorAll('.slot-zone.active').forEach(z => z.classList.remove('active'));
        
        const zonesSection = document.querySelector('.zones-section');
        const confirmationSection = document.querySelector('.zone-confirmation-section');
        
        zonesSection.style.opacity = '0';
        zonesSection.style.transform = 'translateY(20px)';
        setTimeout(() => {
            zonesSection.style.display = 'none';
        }, 300);
        
        confirmationSection.style.opacity = '0';
        confirmationSection.style.transform = 'translateY(20px)';
        setTimeout(() => {
            confirmationSection.style.display = 'none';
        }, 300);
    }

    async function loadPastSlots() {
        showNotification("–†–∞–∑–¥–µ–ª –∏—Å—Ç–æ—Ä–∏–∏ —Å–ª–æ—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ");
    }


    //DAMAGE-PAGE.JS - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–æ–º–æ–∫

    function getVehicleInfo(number) {
        const num = parseInt(number);
        
        if (isNaN(num)) {
            return {
                valid: false,
                type: 'unknown',
                range: null,
                min: null,
                max: null
            };
        }
        
        const vehicleRanges = [
            { min: 20000, max: 23030, type: 'bike_clicklock', label: '–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ 2.0' },
            { min: 23031, max: 29030, type: 'bike_smartlock', label: '–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ 2.1-2.2' },
            { min: 60000, max: 60050, type: 'kid_bike', label: '–î–µ—Ç—Å–∫–∏–π –≤–µ–ª–æ—Å–∏–ø–µ–¥' },
            { min: 70000, max: 70300, type: 'escooter', label: '–≠–ª–µ–∫—Ç—Ä–æ—Å–∫—É—Ç–µ—Ä' },
            { min: 80000, max: 80214, type: 'mech_bike', label: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π –≤–µ–ª–æ—Å–∏–ø–µ–¥' }
        ];
        
        for (const range of vehicleRanges) {
            if (num >= range.min && num <= range.max) {
                return {
                    valid: true,
                    type: range.type,
                    label: range.label,
                    range: `${range.min}-${range.max}`,
                    min: range.min,
                    max: range.max,
                    number: num
                };
            }
        }
        
        return {
            valid: false,
            type: 'unknown',
            label: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¢–°',
            range: null,
            min: null,
            max: null,
            number: num
        };
    }

    function checkVehicleType(number) {
        if (document.querySelector('.modal.active')) {
            return false;
        }
        
        const vehicle = getVehicleInfo(number);
        
        if (!vehicle.valid) {
            return true;
        }
        
        const unsupportedTypes = ['kid_bike', 'escooter', 'mech_bike'];
        
        if (unsupportedTypes.includes(vehicle.type)) {
            let title, message;
            
            switch(vehicle.type) {
                case 'kid_bike':
                    title = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ –¥–µ—Ç—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤';
                    message = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ –¥–µ—Ç—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ó–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç –æ—Å—Ç–∞–≤—å —á–µ—Ä–µ–∑ —á–∞—Ç "–†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"';
                    break;
                case 'escooter':
                    title = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ —ç–ª–µ–∫—Ç—Ä–æ—Å–∫—É—Ç–µ—Ä–æ–≤';
                    message = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ —ç–ª–µ–∫—Ç—Ä–æ—Å–∫—É—Ç–µ—Ä–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ó–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç –æ—Å—Ç–∞–≤—å —á–µ—Ä–µ–∑ —á–∞—Ç "–†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"';
                    break;
                case 'mech_bike':
                    title = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤';
                    message = '–§–∏–∫—Å–∞—Ü–∏—è –ø–æ–ª–æ–º–æ–∫ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ó–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç –æ—Å—Ç–∞–≤—å —á–µ—Ä–µ–∑ —á–∞—Ç "–†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"';
                    break;
            }
            
            showVehicleTypeModal(title, message);
            return false;
        }
        
        return true;
    }

    function showVehicleTypeModal(title, message) {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <h2 class="modal-title">${title}</h2>
                <p class="modal-text">${message}</p>
                <button class="modal-btn" id="vehicle-modal-ok-btn">–ü–æ–Ω—è–ª</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.activeElement?.blur();
        
        const closeModal = () => {
            modal.classList.add('fade-out');
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        };
        
        document.getElementById('vehicle-modal-ok-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    }

    function validateBikeNumberInput() {
        const bikeNumberInput = document.getElementById('bike-number');
        const number = bikeNumberInput.value.trim();
        const numberError = document.getElementById('number-error');
        const vehicle = getVehicleInfo(number);

        if (number.length === 5) {
            if (!checkVehicleType(number)) {
                bikeNumberInput.value = '';
                numberError.style.display = 'none';
                return;
            }
            
            if (vehicle.valid) {
                currentBikeNumber = number;
                numberError.style.display = 'none';
                bikeNumberInput.style.borderColor = '';
                if (!window.bikeNumberValidated) {
                    showNotification(`–ù–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ${number} –ø—Ä–∏–Ω—è—Ç`);
                    window.bikeNumberValidated = true;
                    
                    startSmartGeoCollection();
                }
                updateSubmitButton();
                
                updateLockType(number);
                animateBikeSVG();
                
            } else {
                numberError.style.display = 'block';
                bikeNumberInput.style.borderColor = '#ff4444';
                window.bikeNumberValidated = false;
            }
        }
    }

    function updateLockType(bikeNumber) {
        const vehicle = getVehicleInfo(bikeNumber);
        const lockElement = document.getElementById('lock');
        
        if (!lockElement) return;
        
        lockElement.innerHTML = '';
        
        if (vehicle.type === 'bike_clicklock') {
            lockElement.innerHTML = `
                <g id="click-lock">
                    <path d="M184 198L191 217.5L144 275.5V198H184Z" fill="#818181" fill-opacity="0"/>
                </g>
                <path d="M188.663 222.855L151.663 268.355C151.163 268.022 149.863 267.055 148.663 265.855C147.463 264.655 148.163 262.689 148.663 261.855L165.663 238.355L162.663 235.355C166.663 230.689 175.063 220.855 176.663 218.855C178.263 216.855 181.663 217.689 183.163 218.355L188.663 222.855Z" fill="#2A2A2A"/>
            `;
        } else if (vehicle.type === 'bike_smartlock') {
            lockElement.innerHTML = `
                <g id="click-lock">
                    <path d="M184 198L191 217.5L144 275.5V198H184Z" fill="#818181" fill-opacity="0"/>
                </g>
                <path d="M190.318 218.377L170.709 242.388L167.611 239.857L187.22 215.847L190.318 218.377Z" fill="#F0F0F0"/>
                <path d="M178.595 211.386L161.517 232.299C161.517 232.299 162.371 235.579 163.929 236.851C165.288 237.96 167.609 239.855 167.609 239.855L187.218 215.846L183.539 212.841C181.98 211.568 178.595 211.386 178.595 211.386Z" fill="#17181C"/>
            `;
        }
        
        const clickLock = lockElement.querySelector('#click-lock');
        if (clickLock) {
            clickLock.addEventListener('click', handlePartClick);
            clickLock.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handlePartClick(e);
            });
        }
    }

    async function loadDamageData() {
        try {
            const response = await fetch('style/static/lists/damages.json');
            const data = await response.json();
            damageData = data.parts;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª–æ–º–∫–∞—Ö');
            damageData = {};
        }
    }

    function centerBikeSVG() {
        const container = document.querySelector('.bike-container');
        const svg = document.querySelector('.bike-svg');
        
        if (container && svg) {
            svg.style.transform = 'scale(0.95)';
            
            requestAnimationFrame(() => {
                const containerWidth = container.clientWidth;
                const svgWidth = svg.scrollWidth;
                
                const scrollLeft = Math.max(0, (svgWidth - containerWidth) / 2);
                
                container.style.scrollBehavior = 'smooth';
                container.scrollLeft = scrollLeft;
            });
        }
    }

    async function loadBikeSVG() {
        try {
            const response = await fetch('style/static/models/vel.svg');
            const svgText = await response.text();
            const svgContainer = document.getElementById('bike-svg-container');
            svgContainer.innerHTML = svgText;
            
            const svg = svgContainer.querySelector('svg');
            if (svg) {
                svg.classList.add('bike-svg');
            }
            
            setTimeout(() => {
                setupBikePartsInteractivity();
            }, 100);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SVG');
            loadFallbackSVG();
        }
    }

    function loadFallbackSVG() {
        const svgContainer = document.getElementById('bike-svg-container');
        svgContainer.innerHTML = ``;
        
        setTimeout(() => {
            setupBikePartsInteractivity();
        }, 100);
    }

    function setupBikePartsInteractivity() {
        const parts = document.querySelectorAll('.bike-part');
        parts.forEach(part => {
            part.style.webkitTapHighlightColor = 'transparent';
            part.style.outline = 'none';
            
            part.addEventListener('click', handlePartClick);
            part.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handlePartClick(e);
            });
        });
    }

    function handlePartClick(event) {
        event.preventDefault();
        event.stopPropagation();

        const partElement = event.currentTarget.closest('.bike-part');
        
        if (!partElement) return;
        
        const partId = partElement.id;
        currentPart = partId;
        
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
        
        partElement.classList.add('active');
        
        showDamageDropdown(partId, partElement);
    }

    function showDamageDropdown(partId, partElement) {
        const dropdown = document.getElementById('damage-dropdown');
        if (!dropdown) return;

        dropdown.style.display = 'none';
        
        dropdown.innerHTML = '';
        dropdown.style.position = 'fixed';

        const damages = damageData[partId] || [];

        const header = document.createElement('div');
        header.className = 'dropdown-header';
        header.textContent = getPartName(partId);
        dropdown.appendChild(header);

        damages.forEach(dmg => {
            const opt = document.createElement('div');
            opt.className = 'damage-option';
            opt.textContent = dmg;
            opt.addEventListener('click', () => {
                selectDamage(dmg, partId);
                closeDropdown();
            });
            dropdown.appendChild(opt);
        });

        const otherWrapper = document.createElement('div');
        otherWrapper.className = 'other-damage-wrapper';

        const otherInput = document.createElement('input');
        otherInput.type = 'text';
        otherInput.placeholder = '–î—Ä—É–≥–∞—è –ø–æ–ª–æ–º–∫–∞...';
        otherInput.className = 'styled-input small-input';
        otherInput.maxLength = 30;

        const addBtn = document.createElement('button');
        addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
        addBtn.className = 'main-btn small-btn';
        addBtn.onclick = () => {
            const text = otherInput.value.trim();
            if (!text) return showNotification('–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –ø–æ–ª–æ–º–∫–∏');
            selectedDamages.push({
                id: Date.now(),
                part: partId,
                description: text,
                custom: true
            });
            updateDamagesList();
            closeDropdown();
        };

        otherWrapper.appendChild(otherInput);
        otherWrapper.appendChild(addBtn);
        dropdown.appendChild(otherWrapper);

        const rect = partElement.getBoundingClientRect();
        const viewport = window.visualViewport || { height: window.innerHeight, width: window.innerWidth, offsetTop: 0, offsetLeft: 0 };

        const dropdownWidth = Math.min(320, viewport.width - 20);
        const dropdownHeight = Math.min(320, (damages.length + 2) * 44 + 90);

        let left = rect.left + rect.width / 2 - dropdownWidth / 2;
        left = Math.max(10, Math.min(left, viewport.width - dropdownWidth - 10));

        let top = rect.bottom + 6;
        const spaceBelow = viewport.height - rect.bottom;
        const spaceAbove = rect.top;

        if (spaceBelow < dropdownHeight + 20 && spaceAbove > dropdownHeight) {
            top = rect.top - dropdownHeight - 6;
        }

        top = top - viewport.offsetTop;

        if (top < 10) top = 10;
        if (top + dropdownHeight > viewport.height - 10) {
            top = viewport.height - dropdownHeight - 10;
        }

        dropdown.style.left = `${left}px`;
        dropdown.style.top = `${top}px`;
        dropdown.style.width = `${dropdownWidth}px`;
        dropdown.style.maxHeight = `${dropdownHeight}px`;
        dropdown.style.display = 'block';
        dropdown.style.zIndex = '10000';
        dropdown.scrollTop = 0;

        function closeDropdown() {
            dropdown.style.display = 'none';
            document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
            document.removeEventListener('click', outsideClickListener);
            window.visualViewport?.removeEventListener('resize', adjustPosition);
            window.visualViewport?.removeEventListener('scroll', adjustPosition);
        }

        function outsideClickListener(event) {
            if (!dropdown.contains(event.target) && !partElement.contains(event.target)) {
                closeDropdown();
            }
        }

        function adjustPosition() {
            if (dropdown.style.display === 'none') return;
            const vv = window.visualViewport || { height: window.innerHeight, width: window.innerWidth, offsetTop: 0 };
            let newTop = rect.bottom + 6 - vv.offsetTop;

            if (vv.height - rect.bottom < dropdown.offsetHeight + 20 && rect.top > dropdown.offsetHeight) {
                newTop = rect.top - dropdown.offsetHeight - 6 - vv.offsetTop;
            }

            if (newTop < 10) newTop = 10;
            if (newTop + dropdown.offsetHeight > vv.height - 10) {
                newTop = vv.height - dropdown.offsetHeight - 10;
            }
            dropdown.style.top = `${newTop}px`;
        }

        window.visualViewport?.addEventListener('resize', adjustPosition);
        window.visualViewport?.addEventListener('scroll', adjustPosition);

        setTimeout(() => {
            document.addEventListener('click', outsideClickListener);
        }, 10);
    }

    function selectDamage(damage, partId) {
        const isAlreadySelected = selectedDamages.some(
            d => d.part === partId && d.description === damage
        );
        
        if (isAlreadySelected) {
            showNotification('–≠—Ç–∞ –ø–æ–ª–æ–º–∫–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–π –¥–µ—Ç–∞–ª–∏');
            return;
        }
        
        const damageId = Date.now();
        
        selectedDamages.push({
            id: damageId,
            part: partId,
            description: damage
        });
        
        updateDamagesList();
        updateSubmitButton();
        
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
        
        document.getElementById('damage-dropdown').style.display = 'none';
        
        showNotification('–ü–æ–ª–æ–º–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    }

    function updateDamagesList() {
        const list = document.getElementById('damages-list');

        const additionalInfoEl = document.getElementById('bike-additional-info');
        if (additionalInfoEl) {
            additionalInfoEl.addEventListener('input', () => {
                additionalInfoEl.style.height = 'auto';
                additionalInfoEl.style.height = Math.min(additionalInfoEl.scrollHeight, 400) + 'px';
            });
        }

        if (selectedDamages.length === 0) {
            list.innerHTML = '<div class="empty-damages">–ü–æ–ª–æ–º–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
            updateSubmitButton();
            return;
        }

        list.innerHTML = '';
        selectedDamages.forEach(damage => {
            const item = document.createElement('div');
            item.className = 'damage-item';

            const info = document.createElement('div');
            info.className = 'damage-info';

            const partName = document.createElement('div');
            partName.className = 'damage-part';
            partName.textContent = getPartName(damage.part);

            const desc = document.createElement('div');
            desc.className = 'damage-description multiline';
            desc.textContent = damage.description;

            info.appendChild(partName);
            info.appendChild(desc);

            const noteWrapper = document.createElement('div');
            noteWrapper.className = 'damage-note-wrapper';

            if (damage.customNote) {
                const noteText = document.createElement('div');
                noteText.className = 'damage-note-text';
                noteText.textContent = `–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${damage.customNote}`;
                noteWrapper.appendChild(noteText);
            }

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-damage';
            removeBtn.setAttribute('data-id', damage.id);
            removeBtn.textContent = '√ó';

            item.appendChild(info);
            item.appendChild(noteWrapper);
            item.appendChild(removeBtn);

            list.appendChild(item);
        });

        document.querySelectorAll('.remove-damage').forEach(btn => {
            btn.addEventListener('click', removeDamage);
        });

        updateSubmitButton();
    }

    function removeDamage(event) {
        const damageId = parseInt(event.target.getAttribute('data-id'));
        selectedDamages = selectedDamages.filter(damage => damage.id !== damageId);
        updateDamagesList();
        updateSubmitButton();
        showNotification('–ü–æ–ª–æ–º–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
    }

    function getPartName(partId) {
        const partNames = {
            'rear-wheel': '–ó–∞–¥–Ω–µ–µ –∫–æ–ª–µ—Å–æ',
            'front-wheel': '–ü–µ—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–µ—Å–æ',
            'motor': '–ú–æ—Ç–æ—Ä',
            'rear-ad-sign': '–ó–∞–¥–Ω–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π —â–∏—Ç',
            'front-ad-sign': '–ü–µ—Ä–µ–¥–Ω–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π —â–∏—Ç',
            'lock': '–ó–∞–º–æ–∫',
            'frame': '–†–∞–º–∞ –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–µ',
            'chain': '–¶–µ–ø—å',
            'battery': '–ê–ö–ë',
            'footboard': '–ü–æ–¥–Ω–æ–∂–∫–∞',
            'saddle': '–°–∏–¥–µ–Ω—å–µ',
            'handlebars': '–†—É–ª—å',
            'pedals': '–ü–µ–¥–∞–ª–∏',
            'chain-guard': '–¶–µ–ø—å –∏ –∑–∞—â–∏—Ç–∞ —Ü–µ–ø–∏',
            'light-marker': '–°–≤–µ—Ç–æ–≤–æ–π –º–∞—Ä–∫–µ—Ä',
            'retroreflector': '–°–≤–µ—Ç–æ–æ—Ç—Ä–∞–∂–∞—Ç–µ–ª—å',
            'gearshift': '–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–µ–π',
            'basket': '–ö–æ—Ä–∑–∏–Ω–∞',
            'cable-block': '–ë–ª–æ–∫ —Ç—Ä–æ—Å–∞',
            'front-light': '–ü–µ—Ä–µ–¥–Ω–∏–π —Ñ–æ–Ω–∞—Ä—å'
        };
        
        return partNames[partId] || partId;
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        const hasValidBikeNumber = currentBikeNumber !== '';
        const hasDamages = selectedDamages.length > 0;
        
        submitBtn.disabled = !(hasValidBikeNumber && hasDamages);
    }

    function animateBikeSVG() {
        const bikeContainer = document.querySelector('.bike-container');
        const bikeSVG = document.querySelector('.bike-svg');
        
        if (!bikeContainer || !bikeSVG) return;
        
        const startScroll = bikeContainer.scrollLeft;
        bikeContainer.style.setProperty('--start-scroll', startScroll + 'px');
        
        bikeContainer.classList.add('animate');
        setTimeout(() => {
            bikeContainer.classList.remove('animate');
            bikeContainer.style.scrollBehavior = 'smooth';
        }, 600);
    }

    async function sendReportToTelegram() {
        const submitBtn = document.getElementById('submit-btn');
        const addInfo = document.getElementById('bike-additional-info');
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            startGeoCollection();
            
            try {
                userLocation = await getLocation();
                document.getElementById('location-info').textContent =
                    `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}`;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
                document.getElementById('location-info').textContent =
                    '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã';
            }

            let userInfo = '';
            if (userData && userData.id) {
                const username = userData.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userData.id}`;
                const fullName = [userData.first_name, userData.last_name].filter(Boolean).join(' ') || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                userInfo = `–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n@${username} (ID: ${userData.id}) ‚Äî ${fullName}\n\n`;
            } else if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
                const username = telegramUser.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${telegramUser.id}`;
                const fullName = [telegramUser.first_name, telegramUser.last_name].filter(Boolean).join(' ') || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                userInfo = `–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n@${username} (ID: ${telegramUser.id}) ‚Äî ${fullName}\n\n`;
            } else {
                userInfo = `–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Ö–∑ –∫—Ç–æ\n\n`;
            }

            let messageText = `<b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</b>\n`;
            messageText += userInfo;
            messageText += `–í–µ–ª–æ—Å–∏–ø–µ–¥: ‚Ññ<code>${currentBikeNumber}</code>\n`;
            messageText += `–í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })}\n\n`;

            messageText += `<b>–°–ø–∏—Å–æ–∫ –ø–æ–ª–æ–º–æ–∫:</b>\n`;
            selectedDamages.forEach((damage, index) => {
                messageText += `${index + 1}. ${getPartName(damage.part)}: ${damage.description}`;
                if (damage.customNote && damage.customNote.length) {
                    messageText += ` (–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${damage.customNote})`;
                }
                messageText += `\n`;
            });

            const additionalInfoEl = document.getElementById('bike-additional-info');
            const bikeAdditionalInfo = additionalInfoEl ? additionalInfoEl.value.trim() : '';
            if (bikeAdditionalInfo) {
                messageText += `\n<b>–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ:</b>\n`;
                messageText += `<blockquote>${bikeAdditionalInfo}</blockquote>\n`;
            }

            messageText += `\n`;

            if (userLocation) {
                messageText += `<b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</b>\n`;
                messageText += `<code>${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}</code>\n`;
                
                if (collectedCoordinates.length > 0) {
                    messageText += `\n<b>–í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (${collectedCoordinates.length} —Ç–æ—á–µ–∫):</b>\n`;
                    collectedCoordinates.forEach((coord, index) => {
                        messageText += `<code>${index + 1}. ${coord.latitude.toFixed(6)}, ${coord.longitude.toFixed(6)} (${coord.accuracy}m)</code>\n`;
                    });
                }
                
                const yandexMapsUrl = `https://yandex.ru/maps/?pt=${userLocation.longitude},${userLocation.latitude}&z=17&l=map`;
                messageText += `\n<a href="${yandexMapsUrl}">–ú–µ—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</a>\n\n`;
            }

            const MAX_MESSAGE_LENGTH = 4096;
            let messages = [];
            
            if (messageText.length > MAX_MESSAGE_LENGTH) {
                const half = Math.floor(messageText.length / 2);
                messages.push(messageText.substring(0, half));
                messages.push(messageText.substring(half));
            } else {
                messages.push(messageText);
            }

            if (currentPhotos.length > 0) {
                for (let i = 0; i < currentPhotos.length; i++) {
                    const photo = currentPhotos[i];
                    const formData = new FormData();
                    formData.append('chat_id', telegramChatId);
                    formData.append('message_thread_id', DAMAGES_TOPIC_ID);
                    
                    if (i === 0) {
                        formData.append('caption', messages[0]);
                        formData.append('parse_mode', 'HTML');
                    }
                    
                    const base64Response = await fetch(photo);
                    const blob = await base64Response.blob();
                    formData.append('photo', blob, `damage_${i + 1}.jpg`);
                    
                    const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.description || 'Telegram API error');
                    
                    if (i === 0 && messages.length > 1) {
                        for (let j = 1; j < messages.length; j++) {
                            const textFormData = new FormData();
                            textFormData.append('chat_id', telegramChatId);
                            textFormData.append('message_thread_id', DAMAGES_TOPIC_ID);
                            textFormData.append('text', messages[j]);
                            textFormData.append('parse_mode', 'HTML');
                            
                            const textResponse = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                                method: 'POST',
                                body: textFormData
                            });
                            
                            if (!textResponse.ok) throw new Error(`HTTP error! status: ${textResponse.status}`);
                        }
                    }
                }
            } else {
                for (let i = 0; i < messages.length; i++) {
                    const formData = new FormData();
                    formData.append('chat_id', telegramChatId);
                    formData.append('message_thread_id', DAMAGES_TOPIC_ID);
                    formData.append('text', messages[i]);
                    formData.append('parse_mode', 'HTML');
                    
                    const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.description || 'Telegram API error');
                }
            }

            document.getElementById('bike-number-confirm').textContent = currentBikeNumber;
            const modal = document.getElementById('confirmation-modal');
            if (modal) modal.classList.add('active');

            stopGeoCollection();
            resetForm();
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ç–µ–ª–µ–≥—É');
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            showNotification(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.`);
            
            stopGeoCollection();
        }
    }

    function resetForm() {
        currentBikeNumber = '';
        selectedDamages = [];
        currentPart = null;
        currentPhotos = [];
        userLocation = null;
        collectedCoordinates = [];
        
        document.getElementById('bike-number').value = '';
        document.getElementById('damages-list').innerHTML = '<div class="empty-damages">–ü–æ–ª–æ–º–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
        document.getElementById('photos-preview-container').innerHTML = '';
        document.getElementById('location-info').textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏';
        document.getElementById('submit-btn').disabled = true;
        
        const additionalInfoEl = document.getElementById('bike-additional-info');
        if (additionalInfoEl) {
            additionalInfoEl.value = '';
            additionalInfoEl.style.height = '70px';
        }
        
        document.querySelectorAll('.bike-part').forEach(p => p.classList.remove('active'));
        updateLockType('20000');
        
        document.getElementById('take-photo-btn').style.display = 'flex';
        document.getElementById('upload-photo-btn').style.display = 'flex';
        
        localStorage.removeItem('velobikeAppState');
    }


    // TIMESTAMP-PAGE.JS

    function initTimestampCanvas() {
        timestampCanvas = document.getElementById('timestamp-canvas');
        if (timestampCanvas) {
            timestampContext = timestampCanvas.getContext('2d');
        }
    }

    function initTimestampEventListeners() {
        const captureBtn = document.getElementById('timestamp-capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const sendBtn = document.getElementById('send-telegram-btn');
        const downloadBtn = document.getElementById('download-btn');
        const modeSelector = document.getElementById('timestamp-mode');
        const fineBikeInput = document.getElementById('fine-bike-number');

        if (captureBtn) captureBtn.onclick = captureTimestampPhoto;
        if (retakeBtn) retakeBtn.onclick = retakeTimestampPhoto;
        if (sendBtn) sendBtn.onclick = sendTimestampToTelegram;
        if (downloadBtn) downloadBtn.onclick = downloadPhoto;
        
        if (modeSelector) {
            modeSelector.addEventListener('change', function() {
                const showFineForm = this.value === 'fine';
                const fineForm = document.getElementById('fine-form');
                
                if (fineForm) {
                    if (showFineForm) {
                        fineForm.style.display = 'block';
                        setTimeout(() => {
                            fineForm.style.opacity = '1';
                            fineForm.style.transform = 'translateY(0)';
                        }, 10);
                    } else {
                        fineForm.style.opacity = '0';
                        fineForm.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            fineForm.style.display = 'none';
                        }, 300);
                    }
                }
                
                updateTimestampCaptureButton();
            });
        }
        
        if (fineBikeInput) {
            fineBikeInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
                const numberError = document.getElementById('fine-number-error');
                
                numberError.style.display = 'none';
                this.style.borderColor = '';
                
                validateFineBikeNumber();
            });
        }
    }

    function toggleFineForm(show) {
        const fineForm = document.getElementById('fine-form');
        if (!fineForm) return;
        
        if (show) {
            fineForm.style.display = 'block';
            setTimeout(() => {
                fineForm.style.opacity = '1';
                fineForm.style.transform = 'translateY(0)';
            }, 10);
        } else {
            fineForm.style.opacity = '0';
            fineForm.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                fineForm.style.display = 'none';
            }, 300);
        }
    }

    function validateFineBikeNumber() {
        const fineBikeInput = document.getElementById('fine-bike-number');
        const number = fineBikeInput.value.trim();
        const numberError = document.getElementById('fine-number-error');
        
        const vehicle = getVehicleInfo(number);
        
        if (number.length === 5 && vehicle.valid) {
            numberError.style.display = 'none';
            fineBikeInput.style.borderColor = '';
            updateTimestampCaptureButton();
            return true;
        } else if (number.length === 5) {
            numberError.style.display = 'block';
            fineBikeInput.style.borderColor = '#ff4444';
            updateTimestampCaptureButton();
            return false;
        } else {
            numberError.style.display = 'none';
            fineBikeInput.style.borderColor = '';
            updateTimestampCaptureButton();
            return false;
        }
    }

    function updateTimestampCaptureButton() {
        const captureBtn = document.getElementById('timestamp-capture-btn');
        const mode = document.getElementById('timestamp-mode').value;
        
        if (mode === 'fine') {
            const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
            const vehicle = getVehicleInfo(fineBikeNumber);
            
            if (!fineBikeNumber || !vehicle.valid) {
                captureBtn.disabled = true;
                captureBtn.querySelector('.btn-text').textContent = '–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –¢–°';
                captureBtn.className = 'timestamp-btn';
                return;
            }
        }
        
        if (timestampState === 'ready') {
            captureBtn.disabled = false;
            captureBtn.querySelector('.btn-text').textContent = '–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å';
            captureBtn.className = 'timestamp-btn primary';
        }
    }

    async function startTimestampProcess() {
        timestampState = 'initial';
        updateTimestampUI();

        try {
            await startTimestampCamera();
            cameraPermissionGranted = true;
            
            timestampState = 'waiting_geo';
            updateTimestampUI();
            
            await getTimestampLocation();
            startGeoCollection();
            
            timestampState = 'ready';
            updateTimestampUI();

            addTimestampTorchButton();

        } catch (error) {
            console.error('Start process error');
            
            if (error.message.includes('–≥–µ–æ–ø–æ–∑–∏—Ü–∏—é')) {
                timestampState = 'waiting_geo';
                updateTimestampUI();
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é');
            } else {
                timestampState = 'initial';
                updateTimestampUI();
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
            }
        }
    }

    async function startTimestampCamera() {
        const video = document.getElementById('timestamp-video');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });

            timestampStream = stream;
            video.srcObject = stream;

            return new Promise((resolve, reject) => {
                video.onloadedmetadata = () => {
                    video.play().then(resolve).catch(reject);
                };
                video.onerror = () => reject(new Error('Video error'));
            });

        } catch (err) {
            console.error('Camera access error');
            throw err;
        }
    }

    async function getTimestampLocation() {
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userCoords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    locationReceived = true;
                    geoPermissionGranted = true;
                    
                    try {
                        userAddress = await getAddressFromCoords(userCoords.latitude, userCoords.longitude);
                        resolve();
                    } catch (error) {
                        reject(new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞'));
                    }
                },
                (error) => {
                    locationReceived = false;
                    reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é'));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        });
    }

    async function getAddressFromCoords(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.address) {
                const addr = data.address;
                const components = [];

                if (addr.town) components.push(addr.town);
                if (addr.suburb) components.push(addr.suburb);
                if (addr.road) components.push(addr.road);
                if (addr.house_number) components.push(addr.house_number);
                if (addr.postcode) components.push(addr.postcode);
                
                return components.join(', ');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
        
        return '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
    }

    async function captureTimestampPhoto() {
        if (timestampState !== 'ready') return;

        timestampState = 'capturing';
        updateTimestampUI();

        const mode = document.getElementById('timestamp-mode').value;
        if (mode === 'fine') {
            toggleFineForm(false);
        }

        setTimeout(async () => {
            try {
                const video = document.getElementById('timestamp-video');
                const canvas = document.getElementById('timestamp-canvas');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                timestampContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                turnOffTorch();
                stopGeoCollection();
                
                if (timestampStream) {
                    timestampStream.getTracks().forEach(track => track.stop());
                    timestampStream = null;
                }

                timestampState = 'processing';
                updateTimestampUI();
                
                await processTimestampPhoto();
                
                timestampState = 'ready_to_send';
                updateTimestampUI();
                
            } catch (error) {
                console.error('Capture error');
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—ä–µ–º–∫–µ —Ñ–æ—Ç–æ');
                retakeTimestampPhoto();
            }
        }, 100);
    }

    async function processTimestampPhoto() {
        const originalCanvas = document.getElementById('timestamp-canvas');
        const mode = document.getElementById('timestamp-mode').value;
        
        try {
            const processedCanvas = document.createElement('canvas');
            const ctx = processedCanvas.getContext('2d');
            
            processedCanvas.width = originalCanvas.width;
            processedCanvas.height = originalCanvas.height;
            
            ctx.drawImage(originalCanvas, 0, 0, processedCanvas.width, processedCanvas.height);

            if (mode === 'fine') {
                await addFineLogoToPhoto(ctx, processedCanvas.width, processedCanvas.height);
            } else {
                await addLogoToPhoto(ctx, processedCanvas.width, processedCanvas.height);
            }
            
            await addMapToPhoto(ctx, processedCanvas.width, processedCanvas.height, mode);
            addTextToPhoto(ctx, processedCanvas.width, processedCanvas.height, mode);
            
            currentProcessedPhoto = processedCanvas.toDataURL('image/jpeg', 0.95);
            
            const previewImg = document.getElementById('processed-photo-preview');
            previewImg.src = currentProcessedPhoto;
            
        } catch (error) {
            console.error('Process photo error');
            throw error;
        }
    }
    
    function addMapToPhoto(ctx, width, height, mode) {
        if (!userCoords) return Promise.resolve();

        return new Promise((resolve) => {
            const mapSize = Math.min(width * 0.3, height * 0.25);
            const mapX = width - mapSize - 20;
            const mapY = 20;
            
            const mapImg = new Image();
            mapImg.crossOrigin = "Anonymous";
            
            const mapUrl = `https://static-maps.yandex.ru/1.x/?ll=${userCoords.longitude},${userCoords.latitude}&size=${Math.round(mapSize)},${Math.round(mapSize)}&z=15&l=map`;
            
            mapImg.onload = () => {
                ctx.drawImage(mapImg, mapX, mapY, mapSize, mapSize);
                
                const markerImg = new Image();
                markerImg.onload = function() {
                    const markerSize = mapSize * 0.5;
                    const markerX = mapX + (mapSize / 2) - (markerSize / 2);
                    const markerY = mapY + (mapSize / 2) - (markerSize / 2);
                    
                    ctx.drawImage(markerImg, markerX, markerY, markerSize, markerSize);
                    
                    ctx.fillStyle = '#E76623';
                    ctx.font = 'bold 15px "Moscow Sans"';
                    ctx.textAlign = 'right';
                    
                    if (mode === 'fine') {
                        const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
                        ctx.fillText(`–ù–æ–º–µ—Ä: ${fineBikeNumber}`, mapX + mapSize, mapY + mapSize + 20);
                    } else {
                        ctx.fillText('–í–µ–ª–æ–±–∞–π–∫. –¢—É—Ç –±—ã–ª –ª–µ—Ö–∞.', mapX + mapSize, mapY + mapSize + 20);
                    }
                    
                    resolve();
                };
                markerImg.onerror = function() {                    
                    ctx.fillStyle = '#E76623';
                    ctx.font = 'bold 15px "Moscow Sans"';
                    ctx.textAlign = 'right';
                    
                    if (mode === 'fine') {
                        const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
                        ctx.fillText(`–ù–æ–º–µ—Ä: ${fineBikeNumber}`, mapX + mapSize, mapY + mapSize + 20);
                    } else {
                        ctx.fillText('–í–µ–ª–æ–±–∞–π–∫. –¢—É—Ç –±—ã–ª –ª–µ—Ö–∞.', mapX + mapSize, mapY + mapSize + 20);
                    }
                    
                    resolve();
                };
                markerImg.src = 'style/static/images/stamp/metka.png';
            };
            
            mapImg.onerror = () => {
                ctx.fillStyle = 'rgba(40, 40, 40, 0.95)';
                ctx.fillRect(mapX, mapY, mapSize, mapSize);
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.8)';
                ctx.lineWidth = 3;
                ctx.strokeRect(mapX, mapY, mapSize, mapSize);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px "Moscow Sans"';
                ctx.textAlign = 'center';
                ctx.fillText('–ö–∞—Ä—Ç–∞', mapX + mapSize/2, mapY + mapSize/2 - 15);
                ctx.fillText('–Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª–∞—Å—å', mapX + mapSize/2, mapY + mapSize/2 + 5);
                ctx.fillText(':(', mapX + mapSize/2, mapY + mapSize/2 + 25);
                
                ctx.fillStyle = '#E76623';
                ctx.font = 'bold 15px "Moscow Sans"';
                ctx.textAlign = 'center';
                
                if (mode === 'fine') {
                    const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
                    ctx.fillText(`–ù–æ–º–µ—Ä: ${fineBikeNumber}`, mapX + mapSize/2, mapY + mapSize + 30);
                } else {
                    ctx.fillText('–í–µ–ª–æ–±–∞–π–∫. –¢—É—Ç –±—ã–ª –ª–µ—Ö–∞.', mapX + mapSize/2, mapY + mapSize + 30);
                }
                
                resolve();
            };
            
            mapImg.src = mapUrl;
        });
    }

    async function addLogoToPhoto(ctx, width, height) {
        return new Promise((resolve) => {
            const logoImg = new Image();
            logoImg.onload = function() {
                const logoWidth = 400;
                const logoHeight = (logoWidth * 313) / 807;
                
                ctx.drawImage(logoImg, 25, 25, logoWidth, logoHeight);
                resolve();
            };
            logoImg.onerror = () => {
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 36px "Moscow Sans"';
                ctx.fillText('Velobike', 25, 70);
                resolve();
            };
            logoImg.src = 'style/static/images/stamp/vblogo.png';
        });
    }

    async function addFineLogoToPhoto(ctx, width, height) {
        return new Promise((resolve) => {
            const logoImg = new Image();
            logoImg.onload = function() {
                const logoWidth = 400;
                const logoHeight = (logoWidth * 313) / 807;
                
                ctx.drawImage(logoImg, 25, 25, logoWidth, logoHeight);
                resolve();
            };
            logoImg.onerror = () => {
                ctx.fillStyle = '#FF4444';
                ctx.font = 'bold 36px "Moscow Sans"';
                ctx.fillText('Velobike FINE', 25, 70);
                resolve();
            };
            logoImg.src = 'style/static/images/stamp/finevblogo.png';
        });
    }

    function addTextToPhoto(ctx, width, height, mode) {
        if (!userCoords || !userAddress) return;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU');
        const dateString = now.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        const coordString = `${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}`;
        
        ctx.fillStyle = '#00ff00';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 3;
        ctx.textAlign = 'center';
        ctx.font = 'bold 20px "Moscow Sans"';
        
        const textX = width / 2;
        const textY = height - 50;
        
        let lines = [
            `${timeString} ‚Äî ${dateString}`,
            coordString
        ];
        
        if (mode === 'fine') {
            const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
        }
        
        const maxCharsPerLine = Math.floor(width / 10);
        if (userAddress.length > maxCharsPerLine) {
            const words = userAddress.split(' ');
            let currentLine = '';
            let formattedAddress = [];
            
            words.forEach(word => {
                if ((currentLine + ' ' + word).length <= maxCharsPerLine) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) formattedAddress.push(currentLine);
                    currentLine = word;
                }
            });
            if (currentLine) formattedAddress.push(currentLine);
            
            if (formattedAddress.length > 2) {
                formattedAddress = [formattedAddress[0], '...' + formattedAddress[formattedAddress.length - 1].slice(-15)];
            }
            lines.push(...formattedAddress);
        } else {
            lines.push(userAddress);
        }
        
        const lineHeight = 28;
        const totalTextHeight = lines.length * lineHeight;
        const startY = Math.max(textY - totalTextHeight, 60);
        
        const finalStartY = Math.min(startY, height - totalTextHeight - 20);
        
        lines.forEach((line, index) => {
            const y = finalStartY + (index * lineHeight);
            ctx.strokeText(line, textX, y);
            ctx.fillText(line, textX, y);
        });
    }

    async function sendTimestampToTelegram() {
        if (timestampState !== 'ready_to_send') return;

        timestampState = 'sending';
        updateTimestampUI();

        try {
            const mode = document.getElementById('timestamp-mode').value;
            
            if (mode === 'fine') {
                await sendPhotoToTelegram();
                clearFineForm();
            } else {
                if (isInTelegram()) {
                    await sendPhotoToTelegram();
                } else {
                    await downloadPhoto();
                }
            }
            
            timestampState = 'sent';
            updateTimestampUI();
            
            if (mode === 'fine') {
                document.getElementById('fine-bike-number-confirm').textContent = document.getElementById('fine-bike-number').value;
                document.getElementById('fine-confirmation-modal').classList.add('active');
            } else {
                const message = isInTelegram() ? '–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!' : '–§–æ—Ç–æ —Å–∫–∞—á–∞–Ω–æ!';
                showNotification(message);
            }
            
        } catch (error) {
            console.error('Send error:', error);
            timestampState = 'ready_to_send';
            updateTimestampUI();
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
    }

    function clearFineForm() {
        document.getElementById('fine-bike-number').value = '';
        document.getElementById('fine-additional-info').value = '';
        document.getElementById('fine-number-error').style.display = 'none';
    }

    async function sendPhotoToTelegram() {
        const base64Response = await fetch(currentProcessedPhoto);
        const blob = await base64Response.blob();
        
        const mode = document.getElementById('timestamp-mode').value;
        let username = '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        let userId = null;
        
        if (userData && userData.id) {
            userId = userData.id;
            username = userData.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userData.id}`;
        } else if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
            const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
            userId = telegramUser.id;
            username = telegramUser.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${telegramUser.id}`;
        } else {
            username = '–±–æ–º–∂–∞ (–±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)';
        }
        
        let result;
        
        if (mode === 'fine') {
            
            const fineBikeNumber = document.getElementById('fine-bike-number').value.trim();
            const fineAdditionalInfo = document.getElementById('fine-additional-info').value.trim();
            
            const fineCaption = `<b>–®–¢–†–ê–§ –ó–ê –ü–ê–†–ö–û–í–ö–£</b>\n\n` +
                `–ù–æ–º–µ—Ä: <code>${fineBikeNumber}</code>\n` +
                `–í—Ä–µ–º—è —Ñ–∏–∫—Å–∞—Ü–∏–∏: ${new Date().toLocaleString('ru-RU')}\n` +
                `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <code>${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}</code>\n` +
                `–ê–¥—Ä–µ—Å: ${userAddress}\n` +
                (collectedCoordinates.length > 0 ? 
                    `\n–í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞ –≤—Ä–µ–º—è —Å—ä–µ–º–∫–∏ (${collectedCoordinates.length} —Ç–æ—á–µ–∫):\n` +
                    collectedCoordinates.map((coord, index) => 
                        `${index + 1}. ${coord.latitude.toFixed(6)}, ${coord.longitude.toFixed(6)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${coord.accuracy}m)`
                    ).join('\n') + '\n' : '') +
                (fineAdditionalInfo ? `\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\n<blockquote>${fineAdditionalInfo}</blockquote>\n` : '') +
                `\n–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª: @${username}\n` +
                `#—à—Ç—Ä–∞—Ñ`;
            
            const fineFormData = new FormData();
            fineFormData.append('chat_id', telegramChatId);
            fineFormData.append('message_thread_id', FINE_TOPIC_ID);
            fineFormData.append('photo', blob, 'timestamp_fine.jpg');
            fineFormData.append('caption', fineCaption);
            fineFormData.append('parse_mode', 'HTML');
            
            const fineResponse = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                method: 'POST',
                body: fineFormData
            });
            
            if (!fineResponse.ok) {
                throw new Error(`HTTP error! status: ${fineResponse.status}`);
            }
            
            result = await fineResponse.json();
            
            if (!result.ok) {
                throw new Error(result.description || 'Telegram API error');
            }
            
            const timestampCaption = `TimeStamp —Ñ–æ—Ç–æ—á–∫–∞ –æ—Ç @${username}\n\n` +
                `–®—Ç—Ä–∞—Ñ –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É –¢–°: ${fineBikeNumber}\n` +
                `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}\n` +
                `–ê–¥—Ä–µ—Å: ${userAddress}\n\n` +
                `#timestamp`;
            
            const timestampFormData = new FormData();
            timestampFormData.append('chat_id', telegramChatId);
            timestampFormData.append('message_thread_id', TIMESTAMP_TOPIC_ID);
            timestampFormData.append('photo', blob, 'timestamp_fine_duplicate.jpg');
            timestampFormData.append('caption', timestampCaption);
            timestampFormData.append('parse_mode', 'HTML');
            
            try {
                await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                    method: 'POST',
                    body: timestampFormData
                });
            } catch (timestampError) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç –≤ timestamp —Ç–æ–ø–∏–∫');
            }
            
        } else {
            
            const timestampCaption = `TimeStamp —Ñ–æ—Ç–æ—á–∫–∞ –æ—Ç @${username}\n\n` +
                `–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${userCoords.latitude.toFixed(6)}, ${userCoords.longitude.toFixed(6)}\n` +
                `–í—ã–¥–∞–Ω –∞–¥—Ä–µ—Å: ${userAddress}\n\n` +
                (collectedCoordinates.length > 0 ? 
                    `–í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞ –≤—Ä–µ–º—è —Å—ä–µ–º–∫–∏ (${collectedCoordinates.length} —Ç–æ—á–µ–∫):\n` +
                    collectedCoordinates.map((coord, index) => 
                        `${index + 1}. ${coord.latitude.toFixed(6)}, ${coord.longitude.toFixed(6)} (—Ç–æ—á–Ω–æ—Å—Ç—å: ${coord.accuracy}m)`
                    ).join('\n') + '\n\n' : '') +
                `#timestamp`;
            
            const timestampFormData = new FormData();
            timestampFormData.append('chat_id', telegramChatId);
            timestampFormData.append('message_thread_id', TIMESTAMP_TOPIC_ID);
            timestampFormData.append('photo', blob, 'timestamp.jpg');
            timestampFormData.append('caption', timestampCaption);
            timestampFormData.append('parse_mode', 'HTML');
            
            const timestampResponse = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                method: 'POST',
                body: timestampFormData
            });
            
            if (!timestampResponse.ok) {
                throw new Error(`HTTP error! status: ${timestampResponse.status}`);
            }
            
            result = await timestampResponse.json();
            
            if (!result.ok) {
                throw new Error(result.description || 'Telegram API error');
            }
            
            if (userId) {
                try {
                    const userFormData = new FormData();
                    userFormData.append('chat_id', userId);
                    userFormData.append('photo', blob, 'timestamp_personal.jpg');
                    userFormData.append('caption', '–õ–æ–≤–∏ —Ñ–æ—Ç–∫—É #timestamp');
                    userFormData.append('parse_mode', 'HTML');
                    
                    await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                        method: 'POST',
                        body: userFormData
                    });
                } catch (userError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                }
            }
        }
        
        return result;
    }

    async function downloadPhoto() {
        return new Promise(async (resolve, reject) => {
            if (!currentProcessedPhoto) {
                reject(new Error('No photo'));
                return;
            }
            
            try {
                const sendPromise = sendPhotoToTelegramWithRetry(3).catch(error => {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫, –Ω–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è:', error);
                });
                
                const link = document.createElement('a');
                link.download = `timestampphoto_${new Date().getTime()}.jpg`;
                link.href = currentProcessedPhoto;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                await sendPromise;
                resolve();
                
            } catch (error) {
                reject(error);
            }
        });
    }

    async function sendPhotoToTelegramWithRetry(maxAttempts = 3) {
        let lastError;
        
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                const result = await sendPhotoToTelegram();
                return result;
            } catch (error) {
                lastError = error;
                console.warn(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxAttempts}):`, error);
                
                if (attempt < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }
        
        throw lastError;
    }

    function retakeTimestampPhoto() {
        timestampState = 'initial';
        
        if (timestampStream) {
            timestampStream.getTracks().forEach(track => track.stop());
            timestampStream = null;
        }
        
        currentProcessedPhoto = null;
        userCoords = null;
        userAddress = null;
        locationReceived = false;
        collectedCoordinates = [];
        
        cameraPermissionGranted = false;
        geoPermissionGranted = false;
        
        const mode = document.getElementById('timestamp-mode').value;
        if (mode === 'fine') {
            toggleFineForm(true);
        }
        
        updateTimestampUI();
        
        setTimeout(() => {
            startTimestampProcess();
        }, 500);
    }

    function updateTimestampUI() {
        const captureBtn = document.getElementById('timestamp-capture-btn');
        const resultControls = document.getElementById('timestamp-result-controls');
        const retakeBtn = document.getElementById('retake-btn');
        const sendBtn = document.getElementById('send-telegram-btn');
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('timestamp-loading');
        const video = document.getElementById('timestamp-video');
        const previewImg = document.getElementById('processed-photo-preview');
        const existingTorchBtn = document.getElementById('timestamp-torch-btn');
        const modeSelector = document.querySelector('.timestamp-mode-selector');
        const fineForm = document.getElementById('fine-form');
        
        if (existingTorchBtn) existingTorchBtn.remove();

        captureBtn.style.display = 'none';
        resultControls.style.display = 'none';
        downloadBtn.style.display = 'none';
        loading.style.display = 'none';
        video.style.display = 'none';
        previewImg.style.display = 'none';
        if (modeSelector) modeSelector.style.display = 'none';
        if (fineForm) fineForm.style.display = 'none';

        captureBtn.disabled = false;
        retakeBtn.disabled = false;
        sendBtn.disabled = false;
        downloadBtn.disabled = false;
        
        const captureBtnContent = captureBtn.querySelector('.btn-content');
        const retakeBtnContent = retakeBtn.querySelector('.btn-content');
        const sendBtnContent = sendBtn.querySelector('.btn-content');
        const downloadBtnContent = downloadBtn.querySelector('.btn-content');
        
        captureBtnContent.innerHTML = '<span class="btn-text">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</span>';
        retakeBtnContent.innerHTML = '<span class="btn-text">–ù–æ–≤–∞—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—è</span>';
        
        if (!isInTelegram()) {
            sendBtnContent.innerHTML = '<span class="btn-text">–°–∫–∞—á–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</span>';
        } else {
            sendBtnContent.innerHTML = '<span class="btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ–ª–µ–≥—É</span>';
        }
        
        downloadBtnContent.innerHTML = '<span class="btn-text">–°–∫–∞—á–∞—Ç—å</span>';

        if (!isInTelegram() && (timestampState === 'ready_to_send' || timestampState === 'sent')) {
            downloadBtn.style.display = 'block';
        }

        switch (timestampState) {
            case 'initial':
                loading.style.display = 'flex';
                loading.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...';
                break;

            case 'waiting_geo':
                if (modeSelector) {
                    modeSelector.style.animation = 'dropdownAppear 0.4s ease-out';
                }
                
                const modeWaitingGeo = document.getElementById('timestamp-mode').value;
                if (fineForm && modeWaitingGeo === 'fine') {
                    fineForm.style.display = 'block';
                    setTimeout(() => {
                        fineForm.style.opacity = '1';
                        fineForm.style.transform = 'translateY(0)';
                    }, 10);
                }
                
                captureBtn.style.display = 'block';
                captureBtn.className = 'timestamp-btn';
                captureBtn.disabled = true;
                captureBtn.querySelector('.btn-text').textContent = '–ñ–¥—ë–º –≥–µ–æ...';
                video.style.display = 'block';
                break;

            case 'ready':                
                const currentModeReady = document.getElementById('timestamp-mode').value;
                if (fineForm && currentModeReady === 'fine') {
                    fineForm.style.display = 'block';
                    setTimeout(() => {
                        fineForm.style.opacity = '1';
                        fineForm.style.transform = 'translateY(0)';
                    }, 10);
                }
                
                captureBtn.style.display = 'block';
                captureBtn.className = 'timestamp-btn primary';
                captureBtn.disabled = false;
                video.style.display = 'block';
                addTimestampTorchButton();
                updateTimestampCaptureButton();
                break;

            case 'capturing':
                captureBtn.style.display = 'block';
                captureBtn.className = 'timestamp-btn';
                captureBtn.disabled = true;
                captureBtn.querySelector('.btn-text').textContent = '–ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–∞–¥—Ä...';
                video.style.display = 'block';
                break;

            case 'processing':
                captureBtn.style.display = 'block';
                captureBtn.className = 'timestamp-btn';
                captureBtn.disabled = true;
                captureBtnContent.innerHTML = '<span class="loading-spinner"></span><span class="btn-text">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>';
                break;

            case 'ready_to_send':
                resultControls.style.display = 'flex';
                previewImg.style.display = 'block';
                
                const modeReadyToSend = document.getElementById('timestamp-mode').value;
                
                if (modeReadyToSend === 'fine') {
                    sendBtn.style.display = 'block';
                    sendBtn.className = 'timestamp-btn primary';
                    sendBtn.disabled = false;
                    sendBtn.querySelector('.btn-text').textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ–ª–µ–≥—É';
                    downloadBtn.style.display = 'none';
                } else {
                    if (isInTelegram()) {
                        sendBtn.style.display = 'block';
                        sendBtn.className = 'timestamp-btn primary';
                        sendBtn.disabled = false;
                        sendBtn.querySelector('.btn-text').textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ–ª–µ–≥—É';
                        downloadBtn.style.display = 'none';
                    } else {
                        sendBtn.style.display = 'none';
                        downloadBtn.style.display = 'block';
                        downloadBtn.className = 'timestamp-btn primary';
                        downloadBtn.disabled = false;
                        downloadBtn.querySelector('.btn-text').textContent = '–°–∫–∞—á–∞—Ç—å';
                    }
                }
                
                retakeBtn.className = 'timestamp-btn';
                retakeBtn.querySelector('.btn-text').textContent = '–ü–µ—Ä–µ—Å–Ω—è—Ç—å';
                break;

            case 'sending':
                resultControls.style.display = 'flex';
                previewImg.style.display = 'block';
                retakeBtn.className = 'timestamp-btn';
                retakeBtn.disabled = true;
                
                const currentModeSending = document.getElementById('timestamp-mode').value;
                
                if (currentModeSending === 'fine') {
                    sendBtn.style.display = 'block';
                    sendBtn.className = 'timestamp-btn primary';
                    sendBtn.disabled = true;
                    sendBtnContent.innerHTML = '<span class="loading-spinner"></span><span class="btn-text">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
                    downloadBtn.style.display = 'none';
                } else {
                    if (isInTelegram()) {
                        sendBtn.style.display = 'block';
                        sendBtn.className = 'timestamp-btn primary';
                        sendBtn.disabled = true;
                        sendBtnContent.innerHTML = '<span class="loading-spinner"></span><span class="btn-text">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
                        downloadBtn.style.display = 'none';
                    } else {
                        sendBtn.style.display = 'none';
                        downloadBtn.style.display = 'block';
                        downloadBtn.className = 'timestamp-btn primary';
                        downloadBtn.disabled = true;
                        downloadBtnContent.innerHTML = '<span class="loading-spinner"></span><span class="btn-text">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...</span>';
                    }
                }
                break;

            case 'sent':
                resultControls.style.display = 'flex';
                previewImg.style.display = 'block';
                
                retakeBtn.className = 'timestamp-btn primary';
                retakeBtn.querySelector('.btn-text').textContent = '–ù–æ–≤–∞—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—è';
                retakeBtn.disabled = false;
                
                const currentModeSent = document.getElementById('timestamp-mode').value;
                
                if (currentModeSent === 'fine') {
                    sendBtn.style.display = 'block';
                    sendBtn.className = 'timestamp-btn';
                    sendBtn.disabled = true;
                    sendBtn.querySelector('.btn-text').textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                    downloadBtn.style.display = 'none';
                } else {
                    if (isInTelegram()) {
                        sendBtn.style.display = 'block';
                        sendBtn.className = 'timestamp-btn';
                        sendBtn.disabled = true;
                        sendBtn.querySelector('.btn-text').textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                        downloadBtn.style.display = 'none';
                    } else {
                        sendBtn.style.display = 'none';
                        downloadBtn.style.display = 'block';
                        downloadBtn.className = 'timestamp-btn primary';
                        downloadBtn.querySelector('.btn-text').textContent = '–°–∫–∞—á–∞–Ω–æ';
                        downloadBtn.disabled = true;
                    }
                }
                break;
        }
    }

    // PROFILE-PAGE.JS

    function loadDemoDataToForm() {
        if (!userData) return;
        
        document.getElementById('demo-id').value = userData.id || 1;
        document.getElementById('demo-first-name').value = userData.first_name || '–í–∞—Å—è';
        document.getElementById('demo-last-name').value = userData.last_name || '–ü—É–ø–∫–∏–Ω';
        document.getElementById('demo-role').value = userData.role || 'scout';
        document.getElementById('demo-slot-status').value = userData.slot_status || 'inactive';
        document.getElementById('demo-slot-zone').value = userData.slot_zone || '3–´';
        document.getElementById('demo-balance').value = userData.balance || 17;
    }

    function softReloadWithAnimation() {
        const loadingScreen = document.getElementById('loading-screen');
        
        loadingScreen.style.display = 'flex';
        loadingScreen.style.opacity = '1';
        loadingScreen.style.zIndex = '9999';
        
        const loadingText = loadingScreen.querySelector('.loading-text');
        if (loadingText) {
            loadingText.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
        }
        
        setTimeout(() => {
            updateProfileInfo();
            setupNavigationForRole(userData);
            updateShiftStatusUI(userData);
            
            switchPage('main');
            
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }, 800);
        }, 600);
    }

    function saveDemoData() {
        const demoData = {
            id: parseInt(document.getElementById('demo-id').value) || 1,
            first_name: document.getElementById('demo-first-name').value.trim() || '–í–∞—Å—è',
            last_name: document.getElementById('demo-last-name').value.trim() || '–ü—É–ø–∫–∏–Ω',
            role: document.getElementById('demo-role').value || 'scout',
            telegram_id: 0,
            username: "@vassya",
            technical_login: "qwerty123",
            slot_status: document.getElementById('demo-slot-status').value || 'pending',
            balance: parseInt(document.getElementById('demo-balance').value) || 17,
            slot_zone: document.getElementById('demo-slot-zone').value.trim() || '3–´'
        };
        
        localStorage.setItem('demoUser', JSON.stringify(demoData));
        
        userData = demoData;
        
        showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        softReloadWithAnimation();
    }

    function initDemoEditor() {
        loadDemoDataToForm();
        
        document.getElementById('demo-save-btn').addEventListener('click', saveDemoData);
    }

    async function loadTelegramAvatar(telegramUserId) {
        if (!telegramWebApp?.initDataUnsafe?.user?.photo_url) return null;
        
        try {
            const fileId = telegramWebApp.initDataUnsafe.user.photo_url.split('=')[1];
            const response = await fetch(
                `https://api.telegram.org/bot${telegramBotToken}/getFile?file_id=${fileId}`
            );
            const data = await response.json();
            
            if (data.ok) {
                return `https://api.telegram.org/file/bot${telegramBotToken}/${data.result.file_path}`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:', error);
        }
        return null;
    }

    function updateProfileInfo() {
        if (!userData) return;
        
        const avatarElement = document.getElementById('profile-avatar');
        const nameElement = document.getElementById('profile-name');
        const roleElement = document.getElementById('profile-role');
        const usernameElement = document.getElementById('profile-username');
        
        let telegramPhotoUrl = null;
        let telegramFirstName = userData.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        
        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
            const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
            telegramPhotoUrl = telegramUser.photo_url;
            telegramFirstName = telegramUser.first_name || telegramFirstName;
        }
        
        if (avatarElement) {
            if (telegramPhotoUrl) {
                avatarElement.innerHTML = `
                    <img src="${telegramPhotoUrl}" 
                        alt="–ê–≤–∞—Ç–∞—Ä"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                        onerror="this.parentElement.textContent='${telegramFirstName.charAt(0).toUpperCase()}'">
                `;
            } else {
                avatarElement.textContent = telegramFirstName.charAt(0).toUpperCase();
            }
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        if (nameElement) {
            const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
            nameElement.textContent = fullName || ''; 
        }
        
        if (roleElement) {
            const roleTranslations = {
                'scout': '–°–∫–∞—É—Ç',
                'charger': '–ß–∞—Ä–¥–∂–µ—Ä', 
                'driver': '–í–æ–¥–∏—Ç–µ–ª—å'
            };
            roleElement.textContent = roleTranslations[userData.role] || userData.role;
        }
        
        if (usernameElement) {
            let username = userData.username || '—é–∑';
            if (!username.startsWith('@')) {
                username = '@' + username;
            }
            usernameElement.textContent = username;
        }
    }

    function declinePoints(number) {
        const lastDigit = number % 10;
        const lastTwoDigits = number % 100;
        
        if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
            return '–±–∞–ª–ª–æ–≤';
        }
        
        if (lastDigit === 1) {
            return '–±–∞–ª–ª';
        }
        
        if (lastDigit >= 2 && lastDigit <= 4) {
            return '–±–∞–ª–ª–∞';
        }
        
        return '–±–∞–ª–ª–æ–≤';
    }

    function updateProfileModal() {
        if (!userData) return;
        
        let telegramId = userData.telegram_id || '1';
        if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
            telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
        }
        
        const elements = {
            'modal-velobike-id': userData.id || '1',
            'modal-role': getRoleTranslation(userData.role) || '‚Äî',
            'modal-telegram-id': telegramId,
            'modal-balance': (userData.balance || 0) + ' –±–∞–ª–ª–æ–≤',
            'modal-created-at': formatHumanDate(userData.created_at || new Date().toISOString()),
            'modal-launch-mode': getLaunchMode()
        };
        
        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }
    }

    function initProfilePage() {
        updateProfileInfo();
        initDemoEditor();
        
        const infoBtn = document.getElementById('profile-info-btn');
        if (infoBtn) {
            infoBtn.addEventListener('click', function() {
                updateProfileModal();
                document.getElementById('profile-details-modal').classList.add('active');
            });
        }
        
        const modalClose = document.getElementById('profile-modal-close');
        const modalOk = document.getElementById('profile-modal-ok');
        const modal = document.getElementById('profile-details-modal');
        
        if (modalClose) {
            modalClose.addEventListener('click', function() {
                hideModal(modal);
            });
        }
        
        if (modalOk) {
            modalOk.addEventListener('click', function() {
                hideModal(modal);
            });
        }
        
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal(this);
                }
            });
        }
        
        const achievementBtn = document.getElementById('achievement-btn');
        if (achievementBtn) {
            achievementBtn.addEventListener('click', function() {
                showNotification('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–≤–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            });
        }
        
        const historyBtn = document.getElementById('requests-history-btn');
        if (historyBtn) {
            historyBtn.addEventListener('click', function() {
                showNotification('–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ —Ç–æ–∂–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            });
        }
    }


    // GEO-UPDATE-PAGE.JS

    let geoBikesList = [];
    let geoCurrentPhoto = null;

    function initGeoUpdatePage() {
        resetGeoForm();
        
        const bikeInput = document.getElementById('geo-bike-input');
        if (bikeInput) {
            bikeInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/\D/g, '');
                if (this.value.length === 5) {
                    validateBikeNumber(this.value);
                }
            });
            
            bikeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addBikeFromInput();
                }
            });
        }
        
        document.getElementById('geo-add-btn').addEventListener('click', addBikeFromInput);
        
        document.getElementById('geo-scan-qr-btn').addEventListener('click', startGeoQRScanner);
        
        document.getElementById('finish-geo-qr-scan-btn').addEventListener('click', stopGeoQRScanner);
        
        document.getElementById('get-location-btn').addEventListener('click', getGeoLocation);
        
        const coordsInput = document.getElementById('geo-coordinates-input');
        if (coordsInput) {
            coordsInput.addEventListener('input', function() {
                validateCoordinates(this.value);
                if (isValidCoordinates(this.value)) {
                    updateMiniMap(this.value);
                }
                updateGeoSubmitButton();
            });
        }
        
        document.getElementById('geo-take-photo-btn').addEventListener('click', openGeoCamera);
        document.getElementById('capture-geo-btn').addEventListener('click', captureGeoPhoto);
        document.getElementById('cancel-geo-camera-btn').addEventListener('click', closeGeoCamera);
        
        document.getElementById('geo-submit-btn').addEventListener('click', sendGeoUpdateToTelegram);
    }

    function validateBikeNumber(number) {
        const vehicle = getVehicleInfo(number);
        return vehicle.valid;
    }

    function addBikeFromInput() {
        const input = document.getElementById('geo-bike-input');
        const number = input.value.trim();
        
        if (number.length !== 5) {
            showNotification('–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä');
            input.focus();
            return;
        }

        if (geoBikesList.includes(number)) {
            showNotification(`${number} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω`);
            input.value = '';
            return;
        }
        
        if (!validateBikeNumber(number)) {
            showNotification(`–ù–æ–º–µ—Ä ${number} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`);
            input.focus();
            return;
        }
        
        addBikeToList(number);
        input.value = '';
        input.focus();
    }

    function addBikeToList(number) {
        if (geoBikesList.length >= 10) {
            showScannerNotice('–ú–∞–∫—Å–∏–º—É–º 10 –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤', 'info');
            return false;
        }
        
        if (geoBikesList.includes(number)) {
            const vehicle = getVehicleInfo(number);
            const typeName = getVehicleTypeNamePlain(vehicle.type);
            showScannerNotice(`${typeName} ${number} —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ`, 'info');
            return false;
        }
        
        geoBikesList.push(number);
        updateBikesListUI();
        updateGeoSubmitButton();
        return true;
    }

    function removeBikeFromList(number) {
        const index = geoBikesList.indexOf(number);
        if (index > -1) {
            geoBikesList.splice(index, 1);
            updateBikesListUI();
            updateGeoSubmitButton();
        }
    }

    function updateBikesListUI() {
        const listContainer = document.getElementById('geo-bikes-list');
        const countElement = document.getElementById('geo-bikes-count');
        
        countElement.textContent = `(${geoBikesList.length} —à—Ç.)`;
        
        if (geoBikesList.length === 0) {
            listContainer.innerHTML = '<div class="empty-list">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 10 —à—Ç—É–∫</div>';
            return;
        }
        
        listContainer.innerHTML = geoBikesList.map(bike => `
            <div class="geo-bike-item" data-bike="${bike}">
                <span class="geo-bike-number">${bike}</span>
                <button class="remove-bike-btn" onclick="removeBikeWithAnimation('${bike}')" title="–£–¥–∞–ª–∏—Ç—å">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/>
                    </svg>
                </button>
            </div>
        `).join('');
    }

    function removeBikeWithAnimation(number) {
        const item = document.querySelector(`.geo-bike-item[data-bike="${number}"]`);
        if (item) {
            item.classList.add('removing');
            setTimeout(() => {
                removeBikeFromList(number);
            }, 300);
        }
    }

    function getGeoLocation() {
        const btn = document.getElementById('get-location-btn');
        const originalText = btn.querySelector('.btn-text').textContent;
        
        btn.disabled = true;
        btn.querySelector('.btn-text').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
        
        if (!navigator.geolocation) {
            showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            btn.disabled = false;
            btn.querySelector('.btn-text').textContent = originalText;
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            position => {
                geoUserLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                const coords = `${geoUserLocation.latitude.toFixed(6)}, ${geoUserLocation.longitude.toFixed(6)}`;
                document.getElementById('geo-coordinates-input').value = coords;
                
                validateCoordinates(coords);
                updateMiniMap(coords);
                
                showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞');
                
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = originalText;
            },
            error => {
                let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é';
                if (error.code === error.PERMISSION_DENIED) {
                    message = '–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö';
                }
                
                showNotification(message);
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = originalText;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    function validateCoordinates(coords) {
        const input = document.getElementById('geo-coordinates-input');
        const isValid = isValidCoordinates(coords);
        
        if (coords.trim() === '') {
            input.style.borderColor = '';
            document.getElementById('mini-map-container').style.display = 'none';
            updateGeoSubmitButton();
            return false;
        }
        
        if (isValid) {
            document.getElementById('mini-map-container').style.display = 'block';
        } else {
            document.getElementById('mini-map-container').style.display = 'none';
        }
        
        updateGeoSubmitButton();
        return isValid;
    }

    function isValidCoordinates(coords) {
        const regex = /^-?\d+\.?\d*\s*,\s*-?\d+\.?\d*$/;
        if (!regex.test(coords)) return false;
        
        const [latStr, lonStr] = coords.split(',').map(s => s.trim());
        const lat = parseFloat(latStr);
        const lon = parseFloat(lonStr);
        
        return !isNaN(lat) && !isNaN(lon);
    }

    function updateMiniMap(coords) {
        if (!isValidCoordinates(coords)) return;
        
        const [lat, lon] = coords.split(',').map(s => parseFloat(s.trim()));
        const mapContainer = document.getElementById('mini-map-container');
        const mapImage = document.getElementById('mini-map-image');
        const mapLoading = document.getElementById('map-loading');
        
        mapLoading.style.display = 'flex';
        mapImage.style.display = 'none';
        
        const mapUrl = `https://static-maps.yandex.ru/1.x/?ll=${lon},${lat}&size=300,300&z=16&l=map&pt=${lon},${lat},pm2blm`;
        
        const img = new Image();
        img.onload = function() {
            mapImage.src = mapUrl;
            mapImage.style.display = 'block';
            mapLoading.style.display = 'none';
        };
        img.onerror = function() {
            mapLoading.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É';
            setTimeout(() => {
                mapLoading.style.display = 'none';
            }, 2000);
        };
        img.src = mapUrl;
    }

    function startGeoQRScanner() {
        const scannerContainer = document.getElementById('geo-qr-scanner-container');
        
        showNotification('–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞');
        
        navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        })
        .then(stream => {
            geoScannerStream = stream;
            const video = document.getElementById('geo-qr-scanner-video');
            video.srcObject = stream;
            scannerContainer.classList.add('active');
            
            video.onloadedmetadata = () => {
                video.play();
                startGeoQRDetection();
                
                addGeoQRTorchButton();
            };
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É');
        });
    }

    function addGeoQRTorchButton() {
        const scannerContainer = document.getElementById('geo-qr-scanner-container');
        if (!scannerContainer || document.getElementById('geo-qr-torch-btn')) return;
        
        const torchBtn = document.createElement('button');
        torchBtn.id = 'geo-qr-torch-btn';
        torchBtn.className = 'camera-btn torch-btn';
        torchBtn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
        torchBtn.title = '–§–æ–Ω–∞—Ä–∏–∫';
        torchBtn.onclick = () => toggleTorch(document.getElementById('geo-qr-scanner-video'));
        
        const scannerButtons = scannerContainer.querySelector('.scanner-buttons');
        if (scannerButtons) {
            const finishBtn = scannerButtons.querySelector('#finish-geo-qr-scan-btn');
            if (finishBtn) {
                scannerButtons.insertBefore(torchBtn, finishBtn);
            } else {
                scannerButtons.appendChild(torchBtn);
            }
        }
        
        updateTorchButton();
    }

    function startGeoQRDetection() {
        const video = document.getElementById('geo-qr-scanner-video');
        const notice = document.getElementById('scanner-notice');
        
        geoQrScanInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        processGeoQRCode(code.data);
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ QR:', error);
                }
            }
        }, 500);
    }

    function getVehicleTypeNamePlain(type) {
        const typeNames = {
            'bike_clicklock': '–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥',
            'bike_smartlock': '–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥', 
            'kid_bike': '–î–µ—Ç—Å–∫–∏–π –≤–µ–ª–æ—Å–∏–ø–µ–¥',
            'escooter': '–≠–ª–µ–∫—Ç—Ä–æ—Å–∫—É—Ç–µ—Ä',
            'mech_bike': '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π –≤–µ–ª–æ—Å–∏–ø–µ–¥',
            'unknown': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¢–°'
        };
        return typeNames[type] || typeNames.unknown;
    }

    function processGeoQRCode(qrData) {
        const match = qrData.match(/https:\/\/velobike\.ru\/shorturl\/omni\/\{?(\d+)\}?/);
        
        if (match && match[1]) {
            const bikeNumber = match[1];
            const now = Date.now();
            
            if (lastScannedBike === bikeNumber && (now - lastScanTime) < 2000) {
                return;
            }
            
            lastScannedBike = bikeNumber;
            lastScanTime = now;
            
            const vehicle = getVehicleInfo(bikeNumber);
            
            if (vehicle.valid) {
                if (geoBikesList.includes(bikeNumber)) {
                    const typeName = getVehicleTypeNamePlain(vehicle.type);
                    showScannerNotice(`${typeName} ${bikeNumber} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω`, 'info');
                } else {
                    if (addBikeToList(bikeNumber)) {
                        const typeName = getVehicleTypeNamePlain(vehicle.type);
                        showScannerNotice(`${typeName} ${bikeNumber} –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
                    }
                }
            } else {
                showScannerNotice(`–ù–æ–º–µ—Ä ${bikeNumber} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`, 'error');
            }
        } else {
            showScannerNotice('QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω', 'error');
        }
    }

    function showScannerNotice(message, type = 'info') {
        const notice = document.getElementById('scanner-notice');
        notice.textContent = message;
        notice.className = 'scanner-notice';
        
        if (type === 'success') {
            notice.classList.add('success');
        }
        
        if (type === 'success') {
            setTimeout(() => {
                if (notice.textContent === message) {
                    notice.className = 'scanner-notice';
                    notice.textContent = '–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥';
                }
            }, 2000);
        }
    }

    function stopGeoQRScanner() {
        if (geoQrScanInterval) {
            clearInterval(geoQrScanInterval);
            geoQrScanInterval = null;
        }
        
        if (geoScannerStream) {
            geoScannerStream.getTracks().forEach(track => track.stop());
            geoScannerStream = null;
        }

        turnOffTorch();
        
        document.getElementById('geo-qr-scanner-container').classList.remove('active');
    }

    function openGeoCamera() {
        navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        })
        .then(stream => {
            geoCameraStream = stream;
            const video = document.getElementById('geo-camera-video');
            video.srcObject = stream;
            document.getElementById('geo-camera-container').classList.add('active');
            
            video.onloadedmetadata = () => {
                video.play();
                
                addGeoCameraTorchButton();
            };
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É');
        });
    }

    function addGeoCameraTorchButton() {
        const cameraContainer = document.getElementById('geo-camera-container');
        if (!cameraContainer || document.getElementById('geo-camera-torch-btn')) return;
        
        const oldControls = cameraContainer.querySelector('.camera-controls');
        if (!oldControls) return;
        
        const captureBtn = oldControls.querySelector('#capture-geo-btn');
        const cancelBtn = oldControls.querySelector('#cancel-geo-camera-btn');
        
        if (!captureBtn || !cancelBtn) return;
        
        const captureHandler = captureBtn.onclick;
        const cancelHandler = cancelBtn.onclick;
        
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'damage-camera-buttons';
        
        const firstRow = document.createElement('div');
        firstRow.className = 'damage-camera-row';
        
        const torchBtn = document.createElement('button');
        torchBtn.id = 'geo-camera-torch-btn';
        torchBtn.className = 'camera-btn torch-btn';
        torchBtn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
        torchBtn.title = '–§–æ–Ω–∞—Ä–∏–∫';
        torchBtn.onclick = () => toggleTorch(document.getElementById('geo-camera-video'));
        
        captureBtn.onclick = captureHandler;
        cancelBtn.onclick = cancelHandler;
        
        firstRow.appendChild(captureBtn);
        firstRow.appendChild(torchBtn);
        
        const secondRow = document.createElement('div');
        secondRow.className = 'damage-camera-row';
        secondRow.appendChild(cancelBtn);
        
        buttonsContainer.appendChild(firstRow);
        buttonsContainer.appendChild(secondRow);
        
        oldControls.replaceWith(buttonsContainer);
        
        updateTorchButton();
    }

    function captureGeoPhoto() {
        const video = document.getElementById('geo-camera-video');
        
        try {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            geoCurrentPhoto = canvas.toDataURL('image/jpeg', 0.9);
            updateGeoPhotoPreview();
            
            closeGeoCamera();
            showNotification('–§–æ—Ç–æ —Å–¥–µ–ª–∞–Ω–æ');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å—ä–µ–º–∫–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—ä–µ–º–∫–µ —Ñ–æ—Ç–æ');
        }
    }

    function closeGeoCamera() {
        if (geoCameraStream) {
            geoCameraStream.getTracks().forEach(track => track.stop());
            geoCameraStream = null;
        }

        turnOffTorch();
        
        document.getElementById('geo-camera-container').classList.remove('active');
    }

    function updateGeoPhotoPreview() {
        const container = document.getElementById('geo-photos-preview-container');
        const takePhotoBtn = document.getElementById('geo-take-photo-btn');
        
        container.innerHTML = '';
        
        if (geoCurrentPhoto) {
            takePhotoBtn.textContent = '–ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'photo-preview-wrapper';
            wrapper.style.position = 'relative';
            
            const img = document.createElement('img');
            img.className = 'photo-preview';
            img.src = geoCurrentPhoto;
            img.alt = '–§–æ—Ç–æ –ø–∞—Ä–∫–æ–≤–∫–∏';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-photo-btn';
            removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            removeBtn.onclick = removeGeoPhoto;
            
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
            container.style.display = 'flex';
            
        } else {
            takePhotoBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ';
            container.style.display = 'none';
        }
        
        updateGeoSubmitButton();
    }

    function removeGeoPhoto() {
        geoCurrentPhoto = null;
        updateGeoPhotoPreview();
    }

    function updateGeoSubmitButton() {
        const submitBtn = document.getElementById('geo-submit-btn');
        if (!submitBtn) return;
        
        const hasBikes = geoBikesList.length > 0;
        const coords = document.getElementById('geo-coordinates-input')?.value.trim() || '';
        const hasValidCoords = isValidCoordinates(coords);
        const hasPhoto = geoCurrentPhoto !== null;
        
        submitBtn.disabled = !(hasBikes && hasValidCoords && hasPhoto);
    }
    
    async function sendGeoUpdateToTelegram() {
        const submitBtn = document.getElementById('geo-submit-btn');
        const coords = document.getElementById('geo-coordinates-input').value.trim();
        
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        
        try {
            const bikesString = geoBikesList.map(bike => `<code>${bike}</code>`).join(', ');
            const now = new Date();
            const timeString = now.toLocaleString('ru-RU');
            const [lat, lon] = coords.split(',').map(s => s.trim());
            
            let messageText = `<b>–û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–ï–û</b>\n\n`;
            
            if (userData) {
                const username = userData.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userData.id}`;
                const fullName = [userData.first_name, userData.last_name].filter(Boolean).join(' ') || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                messageText += `–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: @${username} (${fullName})\n\n`;
            }
            
            messageText += `<b>–í–µ–ª–æ—Å–∏–ø–µ–¥—ã (${geoBikesList.length} —à—Ç):</b>\n`;
            messageText += bikesString + '\n\n';
            messageText += `<b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</b>\n<code>${coords}</code>\n\n`;
            messageText += `<b>–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</b>\n${timeString}\n\n`;
            
            const yandexMapsUrl = `https://yandex.ru/maps/?pt=${lon},${lat}&z=17&l=map`;
            messageText += `<a href="${yandexMapsUrl}">–ú–µ—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</a>\n\n`;
            messageText += `#–≥–µ–æ #–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ`;

            if (geoCurrentPhoto) {
                const base64Response = await fetch(geoCurrentPhoto);
                const blob = await base64Response.blob();
                
                const photoFormData = new FormData();
                photoFormData.append('chat_id', telegramChatId);
                photoFormData.append('caption', messageText);
                photoFormData.append('parse_mode', 'HTML');
                photoFormData.append('photo', blob, 'geo_photo.jpg');
                
                const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                    method: 'POST',
                    body: photoFormData
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (!result.ok) throw new Error(result.description || 'Telegram API error');
                
            } else {
                const textFormData = new FormData();
                textFormData.append('chat_id', telegramChatId);
                textFormData.append('text', messageText);
                textFormData.append('parse_mode', 'HTML');
                
                const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                    method: 'POST',
                    body: textFormData
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (!result.ok) throw new Error(result.description || 'Telegram API error');
            }
            
            const modal = document.getElementById('geo-confirmation-modal');
            if (modal) {
                modal.classList.add('active');
            }
            
            resetGeoForm();
            updateGeoSubmitButton();   
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            showNotification(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '–ì–æ—Ç–æ–≤–æ';
        }
    }

    function resetGeoForm() {
        geoBikesList = [];
        geoCurrentPhoto = null;
        geoUserLocation = null;

        document.getElementById('geo-bike-input').value = '';
        document.getElementById('geo-coordinates-input').value = '';
        
        updateBikesListUI();
        updateGeoPhotoPreview();
        document.getElementById('mini-map-container').style.display = 'none';
    }

    // TASKS-PAGE.JS

    async function loadTasks() {
        try {
            if (!userData) {
                console.warn('userData –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å...');
                userData = await loadDemoUserData();
            }
            
            const response = await fetch('style/static/lists/tasks.json');
            const data = await response.json();
            
            const userId = userData?.id || 0;
            const userZone = userData?.slot_zone || null;
                        
            currentTasks = data.tasks.filter(task => {
                if (task.status !== 0) return false;
                
                if (task.assignedTo && task.assignedTo.length > 0) {
                    return task.assignedTo.includes(userId);
                }
                
                if (task.zone) {
                    return task.zone === userZone;
                }
                
                return true;
            });
            
            renderTasks();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            document.getElementById('tasks-list').innerHTML = 
                '<div class="tasks-loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</div>';
        }
    }

    function renderTasks() {
        const tasksList = document.getElementById('tasks-list');
        
        if (currentTasks.length === 0) {
            tasksList.innerHTML = '<div class="tasks-loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
            return;
        }

        const sortedTasks = [...currentTasks].sort((a, b) => {
            if (a.priority !== b.priority) {
                return a.priority - b.priority;
            }
            const priorityOrder = { 'codd': 1, 'other-high': 2, 'normal': 3, 'other-low': 4 };
            const aTypeOrder = priorityOrder[a.type] || 5;
            const bTypeOrder = priorityOrder[b.type] || 5;
            return aTypeOrder - bTypeOrder;
        });

        tasksList.innerHTML = sortedTasks.map(task => {
            const hasImages = task.images && task.images.length > 0;
            const photoCount = hasImages ? task.images.length : 0;
            const hasDescription = task.shortDescription && task.shortDescription.trim() !== '';
            
            const typeColor = task.typeColor;
            
            let bikeInfo = '';
            if (task.bikeNumbers && task.bikeNumbers.length > 0) {
                if (task.bikeNumbers.length === 1) {
                    bikeInfo = `–í–µ–ª–æ—Å–∏–ø–µ–¥: ${task.bikeNumbers[0]}`;
                } else {
                    bikeInfo = `–¢–°: ${task.bikeNumbers.length} —à—Ç`;
                }
            }
            
            const descriptionText = bikeInfo 
                ? `${bikeInfo}${hasDescription ? ' ‚Ä¢ ' + task.shortDescription : ''}`
                : (hasDescription ? task.shortDescription : '');
            
            return `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-card-header">
                        <div class="task-card-title">${task.title}</div>
                        <div class="task-card-type">
                            <span class="type-dot" style="background-color: ${typeColor}"></span>
                            <span>${task.typeLabel || '–ó–∞–¥–∞—á–∞'}</span>
                        </div>
                    </div>
                    ${descriptionText ? `<div class="task-card-description">${descriptionText}</div>` : ''}
                    <div class="task-card-footer">
                        <div class="task-card-time">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            –ó–∞–¥–∞—á–∞ –≤—ã–¥–∞–Ω–∞ ${formatTaskTime(task.createdAt)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        document.querySelectorAll('.task-card').forEach(card => {
            card.addEventListener('click', function() {
                const taskId = parseInt(this.dataset.taskId);
                const task = currentTasks.find(t => t.id === taskId);
                if (task) {
                    openTaskModal(task);
                }
            });
        });
    }

    function formatTaskTime(dateString) {
        const date = new Date(dateString);
        const time = date.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const day = date.getDate();
        const year = date.getFullYear();
        
        const monthsGenitive = [
            '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
            '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
        ];
        
        const month = monthsGenitive[date.getMonth()];
        
        return `${day} ${month} –≤ ${time}`;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å :(');
        });
    }

    function openTaskModal(task) {
        const modal = document.getElementById('task-modal');
        document.body.style.overflow = 'hidden';

        document.getElementById('task-modal-title').textContent = task.title;
        document.getElementById('task-modal-type').textContent = task.typeLabel || '–ó–∞–¥–∞—á–∞';
        document.getElementById('task-modal-type').style.backgroundColor = task.typeColor || '#2196F3';
        
        const descriptionEl = document.getElementById('task-modal-full-description');
        if (task.fullDescription && task.fullDescription.trim() !== '') {
            descriptionEl.textContent = task.fullDescription;
            descriptionEl.parentElement.style.display = 'block';
        } else {
            descriptionEl.textContent = '';
            descriptionEl.parentElement.style.display = 'none';
        }
        
        const bikeNumberItem = document.getElementById('task-bike-number-item');
        const bikeNumberLabel = bikeNumberItem.querySelector('.detail-label');
        const bikeNumberEl = document.getElementById('task-modal-bike-number');
        
        if (task.bikeNumbers && task.bikeNumbers.length > 0) {

            const labelText = task.bikeNumbers.length === 1 ? '–ù–æ–º–µ—Ä –¢–°:' : '–ù–æ–º–µ—Ä–∞ –¢–°:';
            bikeNumberLabel.textContent = labelText;
            
            bikeNumberEl.innerHTML = '';
            bikeNumberEl.style.flexWrap = 'wrap';
            bikeNumberEl.style.gap = '8px';
            bikeNumberEl.style.alignItems = 'center';
            
            task.bikeNumbers.forEach(num => {
                const chip = document.createElement('span');
                
                chip.className = 'bike-number-badge';
                
                chip.textContent = num;
                chip.dataset.bike = num;
                chip.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä';
                
                chip.onclick = (e) => {
                    e.stopPropagation();
                    copyToClipboard(num);
                };
                
                bikeNumberEl.appendChild(chip);
            });
            
            bikeNumberItem.style.display = 'flex';
            bikeNumberItem.style.alignItems = 'center';
            
        } else {
            bikeNumberItem.style.display = 'none';
        }
        
        const addressEl = document.getElementById('task-modal-address');
        const zoneEl = document.getElementById('task-modal-zone');
        const coordsEl = document.getElementById('task-modal-coords');
        
        addressEl.textContent = task.address || '';
        zoneEl.textContent = task.zone || '';
        
        const coordText = task.coordinates ? 
            `${task.coordinates.latitude.toFixed(6)}, ${task.coordinates.longitude.toFixed(6)}` : '';
        coordsEl.textContent = coordText;
        
        if (task.coordinates) {
            coordsEl.style.cursor = 'pointer';
            coordsEl.style.textDecoration = 'underline';
            coordsEl.style.color = 'var(--primary-text)';
            coordsEl.title = '–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            
            coordsEl.onclick = (e) => {
                e.stopPropagation();
                copyToClipboard(coordText);
            };
        }
        
        document.getElementById('task-address-item').style.display = task.address ? 'flex' : 'none';
        document.getElementById('task-zone-item').style.display = task.zone ? 'flex' : 'none';
        document.getElementById('task-coords-item').style.display = task.coordinates ? 'flex' : 'none';
        
        currentTaskImages = task.images || [];
        currentImageIndex = 0;
        
        updateTaskModalImage();
        
        const navigateBtn = document.getElementById('task-navigate-btn');
        if (task.coordinates) {
            navigateBtn.style.display = 'flex';
            navigateBtn.onclick = function() {
                openNavigation(task.coordinates.latitude, task.coordinates.longitude);
            };
        } else {
            navigateBtn.style.display = 'none';
        }

        const completeBtn = document.getElementById('task-complete-btn');
        completeBtn.onclick = function() {
            completeTask(task.id);
            hideModal(modal);
        };

        modal.classList.add('active');
    }

    function updateTaskModalImage() {
        const imageEl = document.getElementById('task-modal-image');
        const counterEl = document.getElementById('task-image-counter');
        const imageContainer = document.getElementById('task-modal-image-container');
        
        const oldPrevZone = imageContainer.querySelector('.click-zone-left');
        const oldNextZone = imageContainer.querySelector('.click-zone-right');
        const oldCenterZone = imageContainer.querySelector('.click-zone-center');
        const oldFullZone = imageContainer.querySelector('.click-zone-full');
        if (oldPrevZone) oldPrevZone.remove();
        if (oldNextZone) oldNextZone.remove();
        if (oldCenterZone) oldCenterZone.remove();
        if (oldFullZone) oldFullZone.remove();
        
        if (currentTaskImages.length === 0) {
            imageEl.src = 'style/static/images/tasks/default.png';
            counterEl.style.display = 'none';
            return;
        }
        
        const currentImage = currentTaskImages[currentImageIndex];
        imageEl.src = currentImage || 'style/static/images/tasks/default.png';
        
        imageEl.onerror = function() {
            this.src = 'style/static/images/tasks/default.png';
        };
        
        const isDefaultImage = currentImage.includes('default.png') || 
                            currentImage.includes('tasks/default');
        
        if (currentTaskImages.length > 1 && !isDefaultImage) {
            counterEl.textContent = `${currentImageIndex + 1}/${currentTaskImages.length}`;
            counterEl.style.display = 'block';
            
            const leftZone = document.createElement('div');
            leftZone.className = 'click-zone-left';
            leftZone.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 30%;
                height: 100%;
                cursor: pointer;
                z-index: 10;
                background: transparent;
            `;
            leftZone.onclick = (e) => {
                e.stopPropagation();
                changeTaskImage(-1);
            };
            imageContainer.appendChild(leftZone);
            
            const rightZone = document.createElement('div');
            rightZone.className = 'click-zone-right';
            rightZone.style.cssText = `
                position: absolute;
                top: 0;
                right: 0;
                width: 30%;
                height: 100%;
                cursor: pointer;
                z-index: 10;
                background: transparent;
            `;
            rightZone.onclick = (e) => {
                e.stopPropagation();
                changeTaskImage(1);
            };
            imageContainer.appendChild(rightZone);
            
            const centerZone = document.createElement('div');
            centerZone.className = 'click-zone-center';
            centerZone.style.cssText = `
                position: absolute;
                top: 0;
                left: 30%;
                width: 40%;
                height: 100%;
                cursor: pointer;
                z-index: 10;
                background: transparent;
            `;
            centerZone.onclick = (e) => {
                e.stopPropagation();
                
                const currentImage = currentTaskImages[currentImageIndex];
                if (currentImage.includes('default.png') || 
                    currentImage.includes('tasks/default')) {
                    showNotification('–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                    return;
                }
                
                openFullscreenImage();
            };
            imageContainer.appendChild(centerZone);
            
        } else if (!isDefaultImage) {
            counterEl.style.display = 'none';
            
            const fullZone = document.createElement('div');
            fullZone.className = 'click-zone-full';
            fullZone.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                cursor: pointer;
                z-index: 10;
                background: transparent;
            `;
            fullZone.onclick = (e) => {
                e.stopPropagation();
                
                const currentImage = currentTaskImages[currentImageIndex];
                if (currentImage.includes('default.png') || 
                    currentImage.includes('tasks/default')) {
                    showNotification('–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                    return;
                }
                
                openFullscreenImage();
            };
            imageContainer.appendChild(fullZone);
        } else {
            counterEl.style.display = currentTaskImages.length > 1 ? 'block' : 'none';
            if (currentTaskImages.length > 1) {
                counterEl.textContent = `${currentImageIndex + 1}/${currentTaskImages.length}`;
            }
        }
    }

    function openFullscreenImage() {
        if (currentTaskImages.length === 0) return;
    
        const currentImage = currentTaskImages[currentImageIndex];
        
        if (currentImage.includes('default.png') || 
            currentImage.includes('tasks/default')) {
            showNotification('–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
            return;
        }
        
        const fullscreenContainer = document.createElement('div');
        fullscreenContainer.id = 'fullscreen-image-container';
        fullscreenContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        `;
        
        const mainContent = document.createElement('div');
        mainContent.style.cssText = `
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
        `;
        
        const fullscreenImage = document.createElement('img');
        fullscreenImage.id = 'fullscreen-image';
        fullscreenImage.src = currentTaskImages[currentImageIndex];
        fullscreenImage.style.cssText = `
            max-width: 95vw;
            max-height: 70vh;
            object-fit: contain;
            cursor: default;
            border-radius: 8px;
        `;
        
        mainContent.appendChild(fullscreenImage);
        
        fullscreenContainer.appendChild(mainContent);
        
        if (currentTaskImages.length > 1) {
            const navContainer = document.createElement('div');
            navContainer.style.cssText = `
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px 0;
                position: absolute;
                bottom: 0;
                left: 0;
                background: linear-gradient(transparent, rgba(0, 0, 0, 0.3));
            `;
            
            const fullscreenCounter = document.createElement('div');
            fullscreenCounter.id = 'fullscreen-counter';
            fullscreenCounter.style.cssText = `
                color: white;
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 15px;
                text-align: center;
            `;
            fullscreenCounter.textContent = `${currentImageIndex + 1}/${currentTaskImages.length}`;
            navContainer.appendChild(fullscreenCounter);
            
            const navButtons = document.createElement('div');
            navButtons.id = 'fullscreen-nav-buttons';
            navButtons.style.cssText = `
                display: flex;
                gap: 20px;
            `;
            
            const prevButton = document.createElement('button');
            prevButton.id = 'fullscreen-prev';
            prevButton.innerHTML = '‚Üê';
            prevButton.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                min-width: 120px;
                transition: all 0.2s;
            `;
            prevButton.onmouseover = () => prevButton.style.background = 'rgba(255, 255, 255, 0.3)';
            prevButton.onmouseout = () => prevButton.style.background = 'rgba(255, 255, 255, 0.2)';
            prevButton.onclick = (e) => {
                e.stopPropagation();
                const fullscreenImage = document.getElementById('fullscreen-image');
                const fullscreenCounter = document.getElementById('fullscreen-counter');
                changeFullscreenImage(-1, fullscreenImage, fullscreenCounter || null);
            };
            
            const nextButton = document.createElement('button');
            nextButton.id = 'fullscreen-next';
            nextButton.innerHTML = '‚Üí';
            nextButton.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                min-width: 120px;
                transition: all 0.2s;
            `;
            nextButton.onmouseover = () => nextButton.style.background = 'rgba(255, 255, 255, 0.3)';
            nextButton.onmouseout = () => nextButton.style.background = 'rgba(255, 255, 255, 0.2)';
            nextButton.onclick = (e) => {
                e.stopPropagation();
                const fullscreenImage = document.getElementById('fullscreen-image');
                const fullscreenCounter = document.getElementById('fullscreen-counter');
                changeFullscreenImage(1, fullscreenImage, fullscreenCounter || null);
            };
            
            navButtons.appendChild(prevButton);
            navButtons.appendChild(nextButton);
            navContainer.appendChild(navButtons);
            fullscreenContainer.appendChild(navContainer);
        }
        
        document.body.appendChild(fullscreenContainer);
        
        fullscreenContainer.onclick = (e) => {
            if (e.target === fullscreenContainer) {
                closeFullscreen();
            }
            
            if (e.target === mainContent) {
                closeFullscreen();
            }
        };
        
        initImageSwipe(fullscreenContainer, true);
        
        document.addEventListener('keydown', handleFullscreenKeydown);
    }

    function changeFullscreenImage(direction, imageElement, counterElement) {
        changeTaskImage(direction);
        
        if (currentTaskImages.length > 0) {
            imageElement.src = currentTaskImages[currentImageIndex];
            if (counterElement) {
                counterElement.textContent = `${currentImageIndex + 1}/${currentTaskImages.length}`;
            }
        }
    }

    function closeFullscreen() {
        const container = document.getElementById('fullscreen-image-container');
        if (container) {
            container.style.animation = 'fadeOut 0.3s ease forwards';
            
            setTimeout(() => {
                document.body.removeChild(container);
            }, 300);
            
            document.removeEventListener('keydown', handleFullscreenKeydown);
        }
    }

    function handleFullscreenKeydown(e) {
        if (e.key === 'Escape') {
            closeFullscreen();
        }
    }

    function changeTaskImage(direction) {
        if (currentTaskImages.length <= 1) return;
        
        currentImageIndex += direction;
        
        if (currentImageIndex < 0) {
            currentImageIndex = currentTaskImages.length - 1;
        } else if (currentImageIndex >= currentTaskImages.length) {
            currentImageIndex = 0;
        }
        
        updateTaskModalImage();
    }

    function initImageSwipe(container, isFullscreen = false) {
        if (!container) {
            console.warn('Swipe container is null');
            return;
        }
        
        let startX = 0;
        let startY = 0;
        let isSwiping = false;
        
        container.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isSwiping = true;
        });
        
        container.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = startX - currentX;
            const diffY = startY - currentY;
            
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                e.preventDefault();
                
                if (isFullscreen) {
                    const fullscreenImage = document.getElementById('fullscreen-image');
                    const fullscreenCounter = document.getElementById('fullscreen-counter');
                    
                    if (diffX > 0) {
                        changeFullscreenImage(1, fullscreenImage, fullscreenCounter || null);
                    } else {
                        changeFullscreenImage(-1, fullscreenImage, fullscreenCounter || null);
                    }
                } else {
                    if (diffX > 0) {
                        changeTaskImage(1);
                    } else {
                        changeTaskImage(-1);
                    }
                }
                
                isSwiping = false;
            }
        });
        
        container.addEventListener('touchend', () => {
            isSwiping = false;
        });
    }

    function openNavigation(lat, lon) {
        url = `https://yandex.ru/maps/?rtext=~${lat},${lon}&rtt=bc`;
        
        window.open(url, '_blank');
    }

    function completeTask(taskId) {
        currentTasks = currentTasks.filter(task => task.id !== taskId);
        renderTasks();
        showNotification('–í –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ–∫—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ');
    }

    function handleQuickAction(action) {
        switch(action) {
            case 'relocation':
                showNotification('–§–æ—Ä–º–∞ –¥–ª—è —Ä–µ–ª–æ–∫–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...');
                break;
            case 'order':
                showNotification('–§–æ—Ä–º–∞ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ —Ç–æ–∂–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...');
                break;
            case 'timestamp':
                switchPage('timestamp');
                break;
        }
    }

    function initTasksPage() {
        loadTasks();
        
        document.querySelectorAll('.quick-action-btn[data-action]').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                handleQuickAction(action);
            });
        });
        
        document.getElementById('task-modal-close').addEventListener('click', function() {
            hideModal(document.getElementById('task-modal'));
            document.body.style.overflow = '';
        });
        
        document.getElementById('task-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                document.body.style.overflow = '';
                hideModal(this);
            }
        });
    }


    // UTILS.JS 

    function isPWAInstalled() {
        return window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true;
    }

    function showPWAPromo() {
        const promo = document.getElementById('pwa-promo');
        if (!isInTelegram() && !isPWAInstalled() && promo) {
            promo.style.display = 'block';
        } else {
            promo.style.display = 'none';
        }
    }

    function checkAndShowPWAPromo() {
        const mainPageActive = window.location.hash === '#main' || document.getElementById('main').classList.contains('active');
        if (mainPageActive && !isInTelegram() && !isPWAInstalled()) {
            setTimeout(showPWAPromo, 1000);
        } else {
            document.getElementById('pwa-promo').style.display = 'none';
        }
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function getLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    resolve(coords);
                },
                error => {
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }

    function hideModal(modal) {
        modal.classList.add('fade-out');
        setTimeout(() => {
            modal.classList.remove('active');
            modal.classList.remove('fade-out');
        }, 300);
    }


    // CAMERA.JS

    function initCamera() {
        const cameraContainer = document.getElementById('camera-container');
        const video = document.getElementById('camera-video');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const uploadPhotoBtn = document.getElementById('upload-photo-btn');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        
        let stream = null;
        
        function startCamera() {
            takePhotoBtn.addEventListener('click', openCamera);
            
            async function openCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });

                    addDamageCameraTorchButton();
                    
                    video.srcObject = stream;
                    cameraContainer.classList.add('active');
                    
                    video.onloadedmetadata = () => {
                        video.play();
                    };
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.capture = 'environment';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                addPhoto(event.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                }
            }
        }
        
        startCamera();
        
        uploadPhotoBtn.addEventListener('click', (e) => {
            e.stopImmediatePropagation();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                files.slice(0, 10 - currentPhotos.length).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        addPhoto(event.target.result);
                    };
                    reader.readAsDataURL(file);
                });
                
                if (files.length > (10 - currentPhotos.length)) {
                    showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${10 - currentPhotos.length} –∏–∑ ${files.length} —Ñ–æ—Ç–æ`);
                }
            };
            input.click();
        });
        
        captureBtn.addEventListener('click', (e) => {
            e.stopImmediatePropagation();
            if (!stream) return;
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                addPhoto(canvas.toDataURL('image/jpeg', 0.95));
                
                turnOffTorch();
                
                closeCamera();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—ä–µ–º–∫–µ —Ñ–æ—Ç–æ');
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—ä–µ–º–∫–µ —Ñ–æ—Ç–æ');
            }
        });
        
        cancelCameraBtn.addEventListener('click', closeCamera);
        
        function closeCamera() {
            turnOffTorch();
            
            document.querySelectorAll('video').forEach(video => {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => {
                        track.stop();
                    });
                    video.srcObject = null;
                }
            });
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            torchStream = null;
            isTorchOn = false;
            
            document.getElementById('camera-container').classList.remove('active');
        }
        
        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ');
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
            closeCamera();
        });
    }

    function startGeoCollection() {
        if (geoWatchId) {
            navigator.geolocation.clearWatch(geoWatchId);
        }
        
        collectedCoordinates = [];
        
        geoWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const coords = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    timestamp: new Date().toISOString(),
                    accuracy: position.coords.accuracy
                };
                
                if (collectedCoordinates.length < MAX_COORDINATES) {
                    collectedCoordinates.push(coords);
                }
            },
            (error) => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏');
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }

    function stopGeoCollection() {
        if (geoWatchId) {
            navigator.geolocation.clearWatch(geoWatchId);
            geoWatchId = null;
        }
    }

    function addPhoto(photoData) {
        if (currentPhotos.length >= 10) {
            showNotification('–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
            return;
        }
        
        currentPhotos.push(photoData);
        updatePhotosPreview();
        showNotification('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    }

    function removePhoto(index) {
        currentPhotos.splice(index, 1);
        updatePhotosPreview();
        showNotification('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
    }

    function updatePhotosPreview() {
        const container = document.getElementById('photos-preview-container');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        
        container.innerHTML = '';
        
        if (currentPhotos.length > 0) {
            takePhotoBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ';
            takePhotoBtn.style.background = 'transparent';
            takePhotoBtn.style.color = 'var(--primary-text)';
            takePhotoBtn.style.borderColor = 'var(--border-color)';
            
            currentPhotos.forEach((photo, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-preview-wrapper';
                wrapper.style.position = 'relative';
                
                const img = document.createElement('img');
                img.className = 'photo-preview';
                img.src = photo;
                img.alt = `–§–æ—Ç–æ ${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-photo-btn';
                removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removePhoto(index);
                };
                
                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);
            });
            
        } else {
            takePhotoBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ';
            takePhotoBtn.style.background = 'var(--primary-text)';
            takePhotoBtn.style.color = 'var(--primary-bg)';
            takePhotoBtn.style.borderColor = 'var(--primary-text)';
        }
        
        document.getElementById('upload-photo-btn').style.display = 'flex';
        
        if (currentPhotos.length === 0) {
            container.style.display = 'none';
        } else {
            container.style.display = 'flex';
        }
    }

    // QR-SCANNER.JS

    function initQRScanner() {
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const fineScanQrBtn = document.getElementById('fine-scan-qr-btn');
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        const qrScannerVideo = document.getElementById('qr-scanner-video');
        const cancelQrScanBtn = document.getElementById('cancel-qr-scan-btn');
        
        scanQrBtn.addEventListener('click', startQRScan);
        if (fineScanQrBtn) fineScanQrBtn.addEventListener('click', startQRScan);
        cancelQrScanBtn.addEventListener('click', stopQRScan);

        if (fineScanQrBtn) {
            fineScanQrBtn.addEventListener('click', startQRScan);
        }
        
        async function startQRScan() {
            showNotification('–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –¢–°');
            try {                
                qrScannerStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                addQRTorchButton();
                
                qrScannerVideo.srcObject = qrScannerStream;
                qrScannerContainer.classList.add('active');
                
                qrScannerVideo.onloadedmetadata = () => {
                    qrScannerVideo.play();
                    startQRDetection();
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
            }
        }
        
        function stopQRScan() {
            if (qrScanInterval) {
                clearInterval(qrScanInterval);
                qrScanInterval = null;
            }
            
            turnOffTorch();
            
            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }
            
            qrScannerContainer.classList.remove('active');
        }
        
        function startQRDetection() {
            let scanAttempts = 0;
            
            qrScanInterval = setInterval(() => {
                if (qrScannerVideo.readyState === qrScannerVideo.HAVE_ENOUGH_DATA) {
                    scanAttempts++;
                    
                    try {
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        
                        canvas.width = qrScannerVideo.videoWidth;
                        canvas.height = qrScannerVideo.videoHeight;
                        
                        context.drawImage(qrScannerVideo, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        if (code) {
                            processQRCode(code.data);
                        }
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ QR-–∫–æ–¥–∞');
                    }
                }
            }, 300);
        }
        
        function processQRCode(qrData) {
            const match = qrData.match(/https:\/\/velobike\.ru\/shorturl\/omni\/\{?(\d+)\}?/);
            const vehicle = getVehicleInfo(bikeNumber);
            
            if (match && match[1]) {
                const bikeNumber = match[1];
                
                if (vehicle.valid && checkVehicleType(bikeNumber)) {
                    const damageInput = document.getElementById('bike-number');
                    const fineInput = document.getElementById('fine-bike-number');
                    
                    if (document.getElementById('fine-form').classList.contains('active') && fineInput) {
                        fineInput.value = bikeNumber;
                        validateFineBikeNumber();
                    } else if (damageInput) {
                        damageInput.value = bikeNumber;
                        validateBikeNumberInput();
                    }
                    
                    stopQRScan();
                    showNotification('–ù–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –ø—Ä–∏–Ω—è—Ç');
                } else {
                    showNotification(`–ù–æ–º–µ—Ä ${bikeNumber} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`);
                    stopQRScan();
                }
            }
        }
    }

    async function toggleTorch(videoElement = null) {
        try {
            const stream = videoElement?.srcObject || timestampStream || qrScannerStream;
            
            if (!stream) {
                showNotification('–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞');
                return;
            }

            const track = stream.getVideoTracks()[0];
            
            if (!track || !track.getCapabilities) {
                showNotification('–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }

            const capabilities = track.getCapabilities();
            
            if (!capabilities.torch) {
                showNotification('–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
                return;
            }

            if (isTorchOn) {
                await track.applyConstraints({
                    advanced: [{ torch: false }]
                });
                isTorchOn = false;
            } else {
                await track.applyConstraints({
                    advanced: [{ torch: true }]
                });
                isTorchOn = true;
            }
            
            updateTorchButton();
            
        } catch (error) {
            console.error('Torch error');
        }
    }

    function turnOffTorch() {
        if (isTorchOn) {
            const stream = timestampStream || qrScannerStream;
            if (stream) {
                const track = stream.getVideoTracks()[0];
                if (track && track.getCapabilities().torch) {
                    track.applyConstraints({
                        advanced: [{ torch: false }]
                    }).catch(() => {});
                }
            }
            isTorchOn = false;
            updateTorchButton();
        }
    }

    function updateTorchButton() {
        const torchBtns = document.querySelectorAll('.torch-btn');
        torchBtns.forEach(btn => {
            if (isTorchOn) {
                btn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
                btn.style.background = 'var(--primary-text)';
                btn.style.color = 'var(--primary-bg)';
            } else {
                btn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
                btn.style.background = 'transparent';
                btn.style.color = 'var(--primary-text)';
            }
        });
    }

    function addTimestampTorchButton() {
        const timestampControls = document.getElementById('timestamp-controls');
        if (!timestampControls || document.getElementById('timestamp-torch-btn')) return;
        
        const torchBtn = document.createElement('button');
        torchBtn.id = 'timestamp-torch-btn';
        torchBtn.className = 'timestamp-icon-btn torch-btn';
        torchBtn.title = '–§–æ–Ω–∞—Ä–∏–∫';
        torchBtn.onclick = () => toggleTorch(document.getElementById('timestamp-video'));
        
        timestampControls.appendChild(torchBtn);
        updateTorchButton();
    }

    function addQRTorchButton() {
        const qrContainer = document.getElementById('qr-scanner-container');
        if (!qrContainer || document.getElementById('qr-torch-btn')) return;
        
        const torchBtn = document.createElement('button');
        torchBtn.id = 'qr-torch-btn';
        torchBtn.className = 'camera-btn torch-btn';
        torchBtn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
        torchBtn.title = '–§–æ–Ω–∞—Ä–∏–∫';
        torchBtn.onclick = () => toggleTorch(document.getElementById('qr-scanner-video'));
        
        const cameraControls = qrContainer.querySelector('.camera-controls');
        if (cameraControls) {
            cameraControls.insertBefore(torchBtn, cameraControls.firstChild);
        }
        updateTorchButton();
    }

    function addDamageCameraTorchButton() {
        const cameraContainer = document.getElementById('camera-container');
        if (!cameraContainer || document.getElementById('damage-torch-btn')) return;
        
        const oldControls = cameraContainer.querySelector('.camera-controls');
        if (!oldControls) return;
        
        const captureBtn = oldControls.querySelector('#capture-btn');
        const cancelBtn = oldControls.querySelector('#cancel-camera-btn');
        
        if (!captureBtn || !cancelBtn) return;
        
        const captureHandler = captureBtn.onclick;
        const cancelHandler = cancelBtn.onclick;
        
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'damage-camera-buttons';
        
        const firstRow = document.createElement('div');
        firstRow.className = 'damage-camera-row';
        
        const torchBtn = document.createElement('button');
        torchBtn.id = 'damage-torch-btn';
        torchBtn.className = 'camera-btn torch-btn';
        torchBtn.innerHTML = `<img src="style/static/images/icons/flashlight.png" alt="–§–æ–Ω–∞—Ä–∏–∫" style="width: 20px; height: 20px;">`;
        torchBtn.title = '–§–æ–Ω–∞—Ä–∏–∫';
        torchBtn.onclick = () => toggleTorch(document.getElementById('camera-video'));
        
        captureBtn.onclick = captureHandler;
        cancelBtn.onclick = cancelHandler;
        
        firstRow.appendChild(captureBtn);
        firstRow.appendChild(torchBtn);
        
        const secondRow = document.createElement('div');
        secondRow.className = 'damage-camera-row';
        secondRow.appendChild(cancelBtn);
        
        buttonsContainer.appendChild(firstRow);
        buttonsContainer.appendChild(secondRow);
        
        oldControls.replaceWith(buttonsContainer);
        
        updateTorchButton();
    }

    // Kakaya-to_fignya.js

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('script/sw.js')
            .then(function(registration) {
                console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
            })
            .catch(function(error) {
                console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker');
            });
        });
    }
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        const installBtn = document.getElementById('pwa-install-btn');
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        document.getElementById('pwa-promo').style.display = 'none';
                    }
                    deferredPrompt = null;
                }
            });
        }
    });

    function startSmartGeoCollection() {
        if (isInTelegram()) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        timestamp: new Date().toISOString(),
                        accuracy: position.coords.accuracy
                    };
                    collectedCoordinates = [coords];
                },
                (error) => {
                    console.log('–ú–∏–Ω–∏-–∞–ø–ø: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            startGeoCollection();
        }
    }

    function formatHumanDate(dateString) {
        const date = new Date(dateString);
        
        if (isNaN(date.getTime())) {
            return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        }
        
        const day = date.getUTCDate();
        const monthIndex = date.getUTCMonth();
        const hours = date.getUTCHours();
        const minutes = date.getUTCMinutes();
        
        const months = [
            '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
            '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
        ];
        
        const month = months[monthIndex];
        
        const today = new Date();
        const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
        const dateUTC = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
        
        const oneDay = 24 * 60 * 60 * 1000;
        const diffDays = Math.floor((todayUTC - dateUTC) / oneDay);
        
        if (diffDays === 0) {
            return `—Å–µ–≥–æ–¥–Ω—è –≤ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        if (diffDays === 1) {
            return `–≤—á–µ—Ä–∞ –≤ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        if (date.getUTCFullYear() === today.getUTCFullYear()) {
            return `${day} ${month} –≤ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        return `${day} ${month} ${date.getUTCFullYear()} –≤ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (window.Telegram && window.Telegram.WebApp) {
            telegramWebApp = window.Telegram.WebApp;
            
            try {
                telegramWebApp.ready();
                telegramWebApp.expand();
                
                if (telegramWebApp.initDataUnsafe && telegramWebApp.initDataUnsafe.user) {
                    userData = telegramWebApp.initDataUnsafe.user;
                }
            } catch (error) {
                console.warn('Error initializing Telegram WebApp');
            }
        }

        const stoolGeoBtn = document.getElementById('stool-geo-btn');
        if (stoolGeoBtn) {
            stoolGeoBtn.addEventListener('click', function() {
                switchPage('geo-update');
            });
        }

        document.getElementById('geo-bike-number')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            const numberError = document.getElementById('geo-number-error');
            
            if (this.value.length !== 5) {
                numberError.style.display = 'none';
                this.style.borderColor = '';
            }
            
            if (this.value.length === 5) {
                validateGeoBikeNumberInput();
            }
        });

        document.getElementById('get-current-location-btn')?.addEventListener('click', getGeoLocation);
        document.getElementById('refresh-location-btn')?.addEventListener('click', getGeoLocation);
        document.getElementById('geo-submit-btn')?.addEventListener('click', sendGeoUpdateToTelegram);

        document.getElementById('geo-modal-close')?.addEventListener('click', function() {
            hideModal(document.getElementById('geo-confirmation-modal'));
        });

        document.getElementById('geo-modal-ok-btn')?.addEventListener('click', function() {
            hideModal(document.getElementById('geo-confirmation-modal'));
            switchPage('stool');
        });

        document.getElementById('geo-confirmation-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });

        const photosContainer = document.getElementById('photos-preview-container');
        if (photosContainer && photosContainer.children.length === 0) {
            photosContainer.style.display = 'none';
            photosContainer.style.marginBottom = '0';
            photosContainer.style.minHeight = '0';
        }

        if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
            userData = window.Telegram.WebApp.initDataUnsafe.user;
        }
        
        setTimeout(centerBikeSVG, 200);
        loadDamageData();
        loadBikeSVG();
        initQRScanner();
        initCamera();
        setupLongPress();
        initializeApp();

        if (shouldShowSlots()) {
            const slotsNav = document.getElementById('slots-nav-item');
            if (slotsNav) {
                slotsNav.style.display = 'flex';
            }
        }
        
        const bikeNumberInput = document.getElementById('bike-number');
        if (bikeNumberInput) {
            bikeNumberInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/\D/g, '');
                const numberError = document.getElementById('number-error');
                
                if (this.value.length !== 5) {
                    numberError.style.display = 'none';
                    this.style.borderColor = '';
                }
                
                if (this.value.length === 5) {
                    window.bikeNumberValidated = false;
                    validateBikeNumberInput();
                }
            });
        }
        
        const additionalInfoEl = document.getElementById('bike-additional-info');
        if (additionalInfoEl) {
            additionalInfoEl.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 400) + 'px';
            });
        }
        
        document.getElementById('submit-btn').addEventListener('click', sendReportToTelegram);
        
        document.getElementById('modal-close').addEventListener('click', function() {
            hideModal(document.getElementById('confirmation-modal'));
        });
        
        document.getElementById('modal-ok-btn').addEventListener('click', function() {
            hideModal(document.getElementById('confirmation-modal'));
        });
        
        document.getElementById('confirmation-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });

        document.getElementById('fine-modal-close').addEventListener('click', function() {
            hideModal(document.getElementById('fine-confirmation-modal'));
        });
        
        document.getElementById('fine-modal-ok-btn').addEventListener('click', function() {
            hideModal(document.getElementById('fine-confirmation-modal'));
            switchPage('stool')
        });
        
        document.getElementById('fine-confirmation-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });
        
        setTimeout(() => {
            switchPage('main');
        }, 500);

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                switchPage(pageId);
            });
        });

        checkAndShowPWAPromo();

        const stoolDamageBtn = document.getElementById('stool-damage-btn');
        const stoolFineBtn = document.getElementById('stool-fine-btn');
        if (stoolDamageBtn) {
            stoolDamageBtn.addEventListener('click', function() {
                switchPage('damage');
            });
        }
        
        if (stoolFineBtn) {
            stoolFineBtn.addEventListener('click', function() {
                switchPage('timestamp');
                
                setTimeout(() => {
                    const modeSelector = document.getElementById('timestamp-mode');
                    if (modeSelector) {
                        modeSelector.value = 'fine';
                        
                        const event = new Event('change');
                        modeSelector.dispatchEvent(event);
                        
                        const fineForm = document.getElementById('fine-form');
                        if (fineForm) {
                            fineForm.style.display = 'block';
                            fineForm.style.opacity = '1';
                            fineForm.style.transform = 'translateY(0)';
                        }
                    }
                }, 100);
            });
        }
    });
    </script>
</body>
</html>
